<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<meta name="theme-color" content="#0055ff">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="description" content="JVS Ultimate PRO - AI-powered vod√°rensk√Ω management s Firebase sync, offline re≈æimem a pokroƒçilou analytikou">
<title>JVS Ultimate PRO | AI Management System</title>

<!-- PWA Manifest -->
<link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiSlZTIFVsdGltYXRlIFBSTyIsInNob3J0X25hbWUiOiJKVlMgUFJPIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiMwMDU1ZmYiLCJ0aGVtZV9jb2xvciI6IiMwMDU1ZmYiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sLCUzQ3N2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAxMDAgMTAwJyUzRSUzQ3JlY3Qgd2lkdGg9JzEwMCcgaGVpZ2h0PScxMDAnIGZpbGw9JyUyMzAwNTVmZicvJTNFJTNDdGV4dCB4PSc1MCcgeT0nNTUnIGZvbnQtc2l6ZT0nNTAnIGZpbGw9J3doaXRlJyB0ZXh0LWFuY2hvcj0nbWlkZGxlJyUzRUolM0MvdGV4dCUzRSUzQy9zdmclM0UiLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=">

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.css">

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">

<style>
:root{--primary:#0055ff;--primary-dark:#0044cc;--accent:#7c3aed;--success:#10b981;--danger:#ef4444;--warning:#f59e0b;--secondary:#64748b;--bg-glass:rgba(255,255,255,0.95);--text-dark:#1e293b;--text-muted:#64748b;--shadow-lg:0 10px 15px -3px rgb(0 0 0/0.1);--radius:14px;--transition:all 0.3s cubic-bezier(0.4,0,0.2,1);}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{font-family:'Inter',sans-serif;overflow:hidden;height:100vh;width:100vw;color:var(--text-dark);background:#f1f5f9;}
#mapWrapper{position:fixed;top:0;left:0;right:0;bottom:0;z-index:0;}
#map{height:100%;width:100%;background:#e5e7eb;}
.fab{pointer-events:auto;position:fixed;width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:none;font-size:22px;box-shadow:var(--shadow-lg);transition:var(--transition);z-index:1100;backdrop-filter:blur(16px);}
.fab:hover{transform:scale(1.1);}.fab:active{transform:scale(0.95);}
.menu-fab{top:20px;left:20px;background:var(--primary);color:white;}
.add-fab{top:20px;right:20px;background:var(--success);color:white;}
.add-fab.active{background:var(--danger);transform:rotate(45deg);}
.ai-fab{bottom:90px;right:20px;background:var(--accent);color:white;animation:pulse-ai 2s infinite;}
.gps-fab{bottom:160px;right:20px;background:var(--warning);color:white;}
.gps-fab.active{background:var(--success);animation:pulse-gps 1.5s infinite;}
@keyframes pulse-ai{0%,100%{box-shadow:0 0 0 0 rgba(124,58,237,0.7);}50%{box-shadow:0 0 0 15px rgba(124,58,237,0);}}
@keyframes pulse-gps{0%,100%{box-shadow:0 0 0 0 rgba(16,185,129,0.7);}50%{box-shadow:0 0 0 12px rgba(16,185,129,0);}}
.quick-stats{pointer-events:auto;position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:var(--bg-glass);backdrop-filter:blur(16px);padding:14px 32px;border-radius:50px;box-shadow:var(--shadow-lg);display:flex;gap:28px;z-index:900;border:1px solid rgba(255,255,255,0.6);}
.qs-item{display:flex;flex-direction:column;align-items:center;gap:4px;}
.qs-val{font-size:20px;font-weight:800;color:var(--primary);}
.qs-lbl{font-size:10px;color:var(--text-muted);font-weight:600;text-transform:uppercase;}
.sidebar{pointer-events:auto;position:fixed;top:0;left:0;bottom:0;width:420px;max-width:90vw;background:var(--bg-glass);backdrop-filter:blur(16px);box-shadow:10px 0 40px rgba(0,0,0,0.12);transform:translateX(-100%);transition:transform 0.4s cubic-bezier(0.4,0,0.2,1);z-index:1050;display:flex;flex-direction:column;border-right:1px solid rgba(255,255,255,0.4);}
.sidebar.active{transform:translateX(0);}
.sidebar-header{padding:28px 24px;background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);color:white;}
.brand-row{display:flex;justify-content:space-between;align-items:center;}
.app-brand{display:flex;align-items:center;gap:14px;}
.brand-icon{width:48px;height:48px;background:rgba(255,255,255,0.2);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:900;backdrop-filter:blur(10px);border:2px solid rgba(255,255,255,0.3);}
.brand-text h1{font-size:22px;font-weight:800;margin-bottom:2px;}
.brand-text p{font-size:11px;opacity:0.85;font-weight:500;}
.close-sidebar{background:rgba(255,255,255,0.15);border:none;color:white;width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;transition:var(--transition);}
.close-sidebar:hover{background:rgba(255,255,255,0.25);}
.sidebar-content{overflow-y:auto;flex:1;padding:20px;}
.panel-section{background:white;border-radius:var(--radius);margin-bottom:16px;border:1px solid #e2e8f0;overflow:hidden;transition:var(--transition);}
.panel-head{padding:18px 20px;font-weight:700;font-size:14px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;color:#475569;background:#fafbfc;}
.panel-head:hover{background:#f1f5f9;}
.panel-head .chevron{transition:transform 0.3s;color:var(--text-muted);}
.panel-section.open .chevron{transform:rotate(180deg);}
.panel-body{max-height:0;overflow:hidden;opacity:0;transition:all 0.4s cubic-bezier(0.4,0,0.2,1);}
.panel-section.open .panel-body{max-height:3000px;padding:20px;opacity:1;}
.form-group{margin-bottom:16px;}
.form-label{display:block;font-size:11px;font-weight:700;color:#64748b;margin-bottom:8px;text-transform:uppercase;}
.form-input,.form-select{width:100%;padding:12px 14px;border:1px solid #e2e8f0;border-radius:10px;font-size:14px;background:#f8fafc;transition:var(--transition);}
.form-input:focus,.form-select:focus{outline:none;border-color:var(--primary);background:white;box-shadow:0 0 0 4px rgba(0,85,255,0.08);}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 20px;border-radius:10px;border:none;font-weight:600;font-size:14px;transition:var(--transition);width:100%;cursor:pointer;}
.btn-primary{background:var(--primary);color:white;}
.btn-primary:hover{background:var(--primary-dark);}
.btn-success{background:var(--success);color:white;}
.btn-danger{background:var(--danger);color:white;}
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.stat-item{background:#f8fafc;padding:16px;border-radius:12px;border:1px solid #f1f5f9;text-align:center;}
.stat-val{font-size:24px;font-weight:800;color:var(--primary);display:block;}
.stat-lbl{font-size:10px;color:#64748b;font-weight:600;text-transform:uppercase;}
.toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:white;padding:12px 24px;border-radius:50px;box-shadow:var(--shadow-lg);display:flex;align-items:center;gap:12px;z-index:9999;animation:slideIn 0.3s ease-out;}
@keyframes slideIn{from{transform:translate(-50%,-20px);opacity:0;}to{transform:translate(-50%,0);opacity:1;}}
.modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);backdrop-filter:blur(8px);z-index:2000;display:none;align-items:center;justify-content:center;padding:20px;}
.modal.active{display:flex;}
.modal-card{background:white;border-radius:var(--radius);max-width:500px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow-lg);}
.modal-header{padding:24px;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center;}
.modal-title{font-size:20px;font-weight:800;color:var(--text-dark);}
.modal-close{background:none;border:none;font-size:28px;color:var(--text-muted);cursor:pointer;width:36px;height:36px;display:flex;align-items:center;justify-content:center;border-radius:8px;transition:var(--transition);}
.modal-close:hover{background:#f1f5f9;color:var(--danger);}
.modal-body{padding:24px;}
.route-list{display:flex;flex-direction:column;gap:8px;margin-top:12px;}
.route-item{background:#f8fafc;padding:12px;border-radius:10px;display:flex;align-items:center;gap:12px;border:1px solid #e2e8f0;cursor:move;}
.route-item:hover{background:white;box-shadow:var(--shadow-lg);}
.route-num{width:32px;height:32px;background:var(--primary);color:white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:14px;}
.route-name{flex:1;font-weight:600;font-size:14px;}
.route-remove{background:none;border:none;color:var(--danger);cursor:pointer;padding:6px;border-radius:6px;transition:var(--transition);}
.route-remove:hover{background:#fee2e2;}
.chart-container{position:relative;height:250px;margin-top:16px;}
@media (max-width:768px){.sidebar{width:100%;}.quick-stats{bottom:16px;gap:16px;padding:10px 20px;width:90vw;}.qs-lbl{display:none;}}
</style>
</head>
<body>

<!-- Map -->
<div id="mapWrapper">
    <div id="map"></div>
</div>

<!-- FAB Buttons -->
<button class="fab menu-fab" onclick="toggleSidebar()" aria-label="Menu">
    <i class="fas fa-bars"></i>
</button>

<button class="fab add-fab" id="addFab" onclick="toggleAddMode()" aria-label="P≈ôidat are√°l">
    <i class="fas fa-plus"></i>
</button>

<button class="fab ai-fab" onclick="openAIModal()" aria-label="AI Asistent">
    <i class="fas fa-robot"></i>
</button>

<button class="fab gps-fab" id="gpsFab" onclick="toggleGPS()" aria-label="GPS">
    <i class="fas fa-location-crosshairs"></i>
</button>

<!-- Quick Stats -->
<div class="quick-stats">
    <div class="qs-item">
        <span class="qs-val" id="qsCount">0</span>
        <span class="qs-lbl">Are√°ly</span>
    </div>
    <div style="width:1px;height:32px;background:#e2e8f0;"></div>
    <div class="qs-item">
        <span class="qs-val" id="qsArea">0</span>
        <span class="qs-lbl">m¬≤</span>
    </div>
    <div style="width:1px;height:32px;background:#e2e8f0;"></div>
    <div class="qs-item">
        <span class="qs-val" id="qsCritical" style="color:var(--danger);">0</span>
        <span class="qs-lbl">Kritick√©</span>
    </div>
</div>

<!-- Sidebar -->
<aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <div class="brand-row">
            <div class="app-brand">
                <div class="brand-icon">J</div>
                <div class="brand-text">
                    <h1>JVS Ultimate PRO</h1>
                    <p>AI Management System</p>
                </div>
            </div>
            <button class="close-sidebar" onclick="toggleSidebar()">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>
    </div>

    <div class="sidebar-content">
        <!-- Filtry -->
        <div class="panel-section open" id="panelFilters">
            <div class="panel-head" onclick="togglePanel('panelFilters')">
                <span><i class="fas fa-filter"></i> Filtry</span>
                <i class="fas fa-chevron-down chevron"></i>
            </div>
            <div class="panel-body">
                <div class="form-group">
                    <label class="form-label">Vyhled√°v√°n√≠</label>
                    <input type="text" class="form-input" id="searchInput" placeholder="N√°zev nebo okres..." oninput="applyFilters()">
                </div>
                <div class="stats-grid">
                    <div class="form-group">
                        <label class="form-label">Okres</label>
                        <select class="form-select" id="okresFilter" onchange="applyFilters()">
                            <option value="all">V≈°echny</option>
                            <option value="CB">ƒå. Budƒõjovice</option>
                            <option value="TA">T√°bor</option>
                            <option value="CK">ƒå. Krumlov</option>
                            <option value="PT">Prachatice</option>
                            <option value="PI">P√≠sek</option>
                            <option value="ST">Strakonice</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Kategorie</label>
                        <select class="form-select" id="katFilter" onchange="applyFilters()">
                            <option value="all">V≈°echny</option>
                            <option value="I.">Kat. I (Vysok√°)</option>
                            <option value="II.">Kat. II (St≈ôedn√≠)</option>
                            <option value="none">Bez kategorie</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="resetFilters()" style="margin-top:12px;">
                    <i class="fas fa-undo"></i> Reset
                </button>
            </div>
        </div>

        <!-- Statistiky -->
        <div class="panel-section" id="panelStats">
            <div class="panel-head" onclick="togglePanel('panelStats')">
                <span><i class="fas fa-chart-line"></i> Statistiky</span>
                <i class="fas fa-chevron-down chevron"></i>
            </div>
            <div class="panel-body">
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-val" id="statCount">0</span>
                        <span class="stat-lbl">Are√°ly</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-val" id="statArea">0</span>
                        <span class="stat-lbl">m¬≤</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-val" id="statFence">0</span>
                        <span class="stat-lbl">Ploty (bm)</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-val" id="statDone" style="color:var(--success);">0</span>
                        <span class="stat-lbl">Hotovo (7d)</span>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="statsChart"></canvas>
                </div>
                <button class="btn btn-primary" onclick="exportCSV()" style="margin-top:16px;">
                    <i class="fas fa-file-csv"></i> Export CSV
                </button>
            </div>
        </div>

        <!-- Pl√°novaƒç tras -->
        <div class="panel-section" id="panelRoute">
            <div class="panel-head" onclick="togglePanel('panelRoute')">
                <span><i class="fas fa-route"></i> Pl√°novaƒç tras</span>
                <i class="fas fa-chevron-down chevron"></i>
            </div>
            <div class="panel-body">
                <div class="form-group">
                    <label class="form-label">Re≈æim pl√°nov√°n√≠</label>
                    <button class="btn btn-success" id="routeModeBtn" onclick="toggleRouteMode()">
                        <i class="fas fa-play"></i> Aktivovat
                    </button>
                </div>
                <div id="routeContent" style="display:none;">
                    <div class="route-list" id="routeList">
                        <p style="text-align:center;color:var(--text-muted);font-size:13px;">Kliknƒõte na markery pro p≈ôid√°n√≠ do trasy...</p>
                    </div>
                    <div class="stats-grid" style="margin-top:16px;">
                        <div class="stat-item">
                            <span class="stat-val" id="routeDistance">0</span>
                            <span class="stat-lbl">KM</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-val" id="routeTime">0</span>
                            <span class="stat-lbl">MIN</span>
                        </div>
                    </div>
                    <div style="display:flex;gap:8px;margin-top:12px;">
                        <button class="btn btn-success" onclick="optimizeRoute()" style="flex:2;">
                            <i class="fas fa-wand-magic-sparkles"></i> Optimalizovat
                        </button>
                        <button class="btn btn-danger" onclick="clearRoute()" style="flex:1;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <button class="btn btn-primary" onclick="generateAIProtocol()" style="margin-top:8px;">
                        <i class="fas fa-robot"></i> AI Protokol
                    </button>
                </div>
            </div>
        </div>
    </div>
</aside>

<!-- AI Modal -->
<div class="modal" id="aiModal">
    <div class="modal-card">
        <div class="modal-header">
            <h2 class="modal-title">ü§ñ AI Protokol</h2>
            <button class="modal-close" onclick="closeAIModal()">√ó</button>
        </div>
        <div class="modal-body" id="aiContent">
            <p style="text-align:center;color:var(--text-muted);">Generuji protokol...</p>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div id="toastContainer"></div>

<!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-heat/0.2.0/leaflet-heat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
// === KONFIGURACE ===
const CONFIG = {
    defaultCenter: [49.15, 14.35],
    defaultZoom: 10,
    avgSpeed: 50,
    storageKey: 'jvs_ultimate_v1'
};

// === DATA ARE√ÅL≈Æ ===
let arealData = [
    {id:1,nazev:"VDJ Amerika II",okres:"PI",kategorie:"I.",oploceni:293,vymera:3303,lat:49.305131,lon:14.166126},
    {id:2,nazev:"VDJ Drahonice",okres:"ST",kategorie:"I.",oploceni:376,vymera:5953,lat:49.202902,lon:14.063713},
    {id:3,nazev:"VDJ Vod≈àany",okres:"ST",kategorie:"I.",oploceni:252,vymera:1594,lat:49.16455,lon:14.177836},
    {id:4,nazev:"VDJ Hlavatce",okres:"CB",kategorie:"",oploceni:424,vymera:7968,lat:49.063584,lon:14.267751},
    {id:5,nazev:"VDJ ≈†ibeniƒçn√≠ vrch I",okres:"PT",kategorie:"I.",oploceni:245,vymera:1835,lat:49.025083,lon:13.994111},
    {id:6,nazev:"√öV Husinecka p≈ôehrada",okres:"PT",kategorie:"",oploceni:703,vymera:4908,lat:49.034362,lon:13.99683},
    {id:7,nazev:"VDJ ≈†ibeniƒçn√≠ vrch II",okres:"PT",kategorie:"I.",oploceni:340,vymera:3206,lat:49.02671,lon:13.994001},
    {id:8,nazev:"VDJ Z√°lu≈æany",okres:"PI",kategorie:"",oploceni:299,vymera:2350,lat:49.552857,lon:14.083381},
    {id:9,nazev:"VDJ Pt√°ƒçn√≠k",okres:"PT",kategorie:"II.",oploceni:239,vymera:1070,lat:49.066147,lon:14.186844},
    {id:10,nazev:"VDJ Zdoba",okres:"CB",kategorie:"II.",oploceni:225,vymera:15523,lat:49.212422,lon:14.338095},
    {id:11,nazev:"VDJ Domoradice",okres:"CK",kategorie:"I.",oploceni:450,vymera:4148,lat:48.829651,lon:14.326564},
    {id:12,nazev:"VDJ Horn√≠ Br√°na",okres:"CK",kategorie:"I.",oploceni:187,vymera:1665,lat:48.80797,lon:14.329352},
    {id:13,nazev:"VDJ Net≈ôebice",okres:"CK",kategorie:"I.",oploceni:136,vymera:877,lat:48.783277,lon:14.456447},
    {id:14,nazev:"VDJ Ple≈°ivec",okres:"CK",kategorie:"I.",oploceni:119,vymera:975,lat:48.802231,lon:14.304933},
    {id:15,nazev:"VDJ Doudleby",okres:"CB",kategorie:"II.",oploceni:79,vymera:413,lat:48.888896,lon:14.480271},
    {id:16,nazev:"VDJ Jankov",okres:"CB",kategorie:"I.",oploceni:106,vymera:784,lat:48.968747,lon:14.301697},
    {id:17,nazev:"VDJ Hos√≠n II",okres:"CB",kategorie:"I.",oploceni:399,vymera:4173,lat:49.030641,lon:14.501012},
    {id:18,nazev:"VDJ Chlum",okres:"CB",kategorie:"II.",oploceni:63,vymera:535,lat:49.096493,lon:14.388679},
    {id:19,nazev:"VDJ Chot√Ωƒçany",okres:"CB",kategorie:"II.",oploceni:338,vymera:4775,lat:49.070748,lon:14.51946},
    {id:20,nazev:"VDJ Rudolfov III",okres:"CB",kategorie:"I.",oploceni:174,vymera:1868,lat:48.986207,lon:14.547076},
    {id:21,nazev:"VDJ Rimov - Vesce",okres:"CB",kategorie:"I.",oploceni:99,vymera:662,lat:48.847847,lon:14.466957},
    {id:22,nazev:"VDJ Hosin",okres:"CB",kategorie:"II.",oploceni:125,vymera:809,lat:49.033641,lon:14.492878},
    {id:23,nazev:"VDJ Vƒçeln√°",okres:"CB",kategorie:"II.",oploceni:476,vymera:8660,lat:48.924663,lon:14.463506},
    {id:24,nazev:"VDJ H√∫ry",okres:"CB",kategorie:"I.",oploceni:0,vymera:395,lat:49.006417,lon:14.549815},
    {id:25,nazev:"VDJ Chlumec",okres:"CB",kategorie:"II.",oploceni:110,vymera:811,lat:49.124766,lon:14.431321},
    {id:26,nazev:"VDJ Ole≈°n√≠k",okres:"CB",kategorie:"I.",oploceni:117,vymera:380,lat:49.111103,lon:14.377766},
    {id:27,nazev:"ƒåS Bukovec",okres:"CB",kategorie:"I.",oploceni:300,vymera:4943,lat:48.881608,lon:14.449233},
    {id:28,nazev:"VDJ He≈ôman",okres:"CB",kategorie:"II.",oploceni:119,vymera:982,lat:48.909479,lon:14.499876},
    {id:29,nazev:"ƒåS Vidov u ≈ôeky",okres:"CB",kategorie:"II.",oploceni:212,vymera:2501,lat:48.924157,lon:14.489619},
    {id:30,nazev:"Vrt Vidov",okres:"CB",kategorie:"II.",oploceni:164,vymera:470,lat:48.924066,lon:14.489679},
    {id:31,nazev:"√öV Plav",okres:"CB",kategorie:"I.",oploceni:1413,vymera:74777,lat:48.912611,lon:14.494018},
    {id:32,nazev:"VDJ ƒåekanice",okres:"TA",kategorie:"I.",oploceni:450,vymera:6344,lat:49.422197,lon:14.689896},
    {id:33,nazev:"VDJ Svat√° Anna",okres:"TA",kategorie:"I.",oploceni:264,vymera:4192,lat:49.401133,lon:14.69864},
    {id:34,nazev:"VDJ Bezdƒõƒç√≠n",okres:"TA",kategorie:"I.",oploceni:169,vymera:1996,lat:49.323096,lon:14.628405},
    {id:35,nazev:"VDJ Milevsko",okres:"TA",kategorie:"I.",oploceni:129,vymera:823,lat:49.452521,lon:14.344102},
    {id:36,nazev:"VDJ Hodu≈°√≠n",okres:"TA",kategorie:"II.",oploceni:205,vymera:1708,lat:49.42967,lon:14.474214},
    {id:37,nazev:"VDJ V≈°echov",okres:"TA",kategorie:"I.",oploceni:199,vymera:1574,lat:49.430159,lon:14.623205},
    {id:38,nazev:"VDJ Zlukov",okres:"TA",kategorie:"II.",oploceni:184,vymera:1520,lat:49.196289,lon:14.736382},
    {id:39,nazev:"√öV T√°bor",okres:"TA",kategorie:"II.",oploceni:350,vymera:12262,lat:49.422872,lon:14.666426},
    {id:40,nazev:"ƒåS Sudomƒõ≈ôice",okres:"TA",kategorie:"I.",oploceni:220,vymera:2508,lat:49.28658,lon:14.547794},
    {id:41,nazev:"Provozn√≠ Vodojem T√°bor",okres:"TA",kategorie:"II.",oploceni:155,vymera:1853,lat:49.413889,lon:14.659167}
];

// === STAV APLIKACE ===
let map, markerCluster, selectedRoute = [], routeMode = false, routeLine = null, currentFilteredData = [], statsChart = null, userLocation = null;

// === INICIALIZACE ===
document.addEventListener('DOMContentLoaded', () => {
    loadData();
    initMap();
    createMarkers(arealData);
    updateStats(arealData);
    initChart();
    registerServiceWorker();
    console.log('üöÄ JVS Ultimate PRO inicializov√°no');
});

function loadData() {
    try {
        const saved = localStorage.getItem(CONFIG.storageKey);
        if (saved) {
            const parsed = JSON.parse(saved);
            arealData = arealData.map(d => {
                const s = parsed.find(x => x.id === d.id);
                return s ? {...d, ...s} : d;
            });
        }
    } catch (e) { console.error('Chyba p≈ôi naƒç√≠t√°n√≠ dat', e); }
}

function saveData() {
    localStorage.setItem(CONFIG.storageKey, JSON.stringify(arealData));
}

// === MAPA ===
function initMap() {
    map = L.map('map', { zoomControl: false }).setView(CONFIG.defaultCenter, CONFIG.defaultZoom);
    
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
        attribution: '¬© OpenStreetMap'
    }).addTo(map);
    
    L.control.zoom({ position: 'bottomright' }).addTo(map);
    
    markerCluster = L.markerClusterGroup({
        maxClusterRadius: 40,
        iconCreateFunction: cluster => L.divIcon({
            html: `<div style="background:var(--primary);color:white;border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center;font-weight:bold;border:3px solid white;box-shadow:var(--shadow-lg);">${cluster.getChildCount()}</div>`,
            className: 'cluster-icon',
            iconSize: L.point(40, 40)
        })
    });
    map.addLayer(markerCluster);
}

function getMarkerColor(areal) {
    if (areal.lastMaintenance && (Date.now() - areal.lastMaintenance < 7 * 86400000)) return '#10b981';
    if (areal.kategorie === 'I.') return '#ef4444';
    if (areal.kategorie === 'II.') return '#f59e0b';
    return '#64748b';
}

function createMarkers(data) {
    markerCluster.clearLayers();
    
    data.forEach(areal => {
        const color = getMarkerColor(areal);
        const icon = L.divIcon({
            className: 'marker-container',
            html: `<div style="width:32px;height:32px;border-radius:50% 50% 50% 0;transform:rotate(-45deg);background:${color};border:3px solid white;box-shadow:0 4px 10px rgba(0,0,0,0.2);"><div style="width:12px;height:12px;background:white;border-radius:50%;margin:7px 0 0 7px;"></div></div>`,
            iconSize: [32, 42],
            iconAnchor: [16, 42]
        });
        
        const marker = L.marker([areal.lat, areal.lon], { icon });
        
        marker.on('click', () => {
            if (routeMode) {
                addToRoute(areal.id);
            } else {
                marker.bindPopup(generatePopup(areal)).openPopup();
            }
        });
        
        markerCluster.addLayer(marker);
    });
    
    currentFilteredData = data;
}

function generatePopup(areal) {
    return `
        <div style="min-width:220px;">
            <h3 style="margin-bottom:8px;border-bottom:2px solid #f1f5f9;padding-bottom:4px;">${areal.nazev}</h3>
            <p><strong>Kat:</strong> ${areal.kategorie || 'Nen√≠'} | <strong>Okres:</strong> ${areal.okres}</p>
            <p><strong>V√Ωmƒõra:</strong> ${areal.vymera.toLocaleString()} m¬≤</p>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:12px;">
                <button class="btn btn-primary" onclick="toggleMaintenance(${areal.id})" style="padding:8px;font-size:12px;">
                    <i class="fas fa-check"></i> Hotovo
                </button>
                <a href="https://www.google.com/maps/dir/?api=1&destination=${areal.lat},${areal.lon}" target="_blank" 
                   style="display:flex;align-items:center;justify-content:center;padding:8px;background:#e2e8f0;border-radius:10px;text-decoration:none;color:var(--text-dark);font-weight:600;font-size:12px;">
                   <i class="fas fa-location-arrow"></i>
                </a>
            </div>
        </div>
    `;
}

function toggleMaintenance(id) {
    const index = arealData.findIndex(x => x.id === id);
    if (index === -1) return;
    
    const current = arealData[index].lastMaintenance;
    if (current && (Date.now() - current < 86400000)) {
        arealData[index].lastMaintenance = null;
        showToast('√ödr≈æba zru≈°ena', 'info');
    } else {
        arealData[index].lastMaintenance = Date.now();
        showToast('√ödr≈æba zaznamen√°na', 'success');
    }
    
    saveData();
    applyFilters();
    map.closePopup();
}

// === FILTRY ===
function applyFilters() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const okres = document.getElementById('okresFilter').value;
    const kat = document.getElementById('katFilter').value;
    
    const filtered = arealData.filter(a => {
        const matchSearch = a.nazev.toLowerCase().includes(search) || a.okres.toLowerCase().includes(search);
        const matchOkres = okres === 'all' || a.okres === okres;
        const matchKat = kat === 'all' || (kat === 'none' ? !a.kategorie : a.kategorie === kat);
        return matchSearch && matchOkres && matchKat;
    });
    
    createMarkers(filtered);
    updateStats(filtered);
}

function resetFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('okresFilter').value = 'all';
    document.getElementById('katFilter').value = 'all';
    applyFilters();
    showToast('Filtry resetov√°ny');
}

// === STATISTIKY ===
function updateStats(data) {
    const count = data.length;
    const area = data.reduce((sum, a) => sum + a.vymera, 0);
    const fence = data.reduce((sum, a) => sum + a.oploceni, 0);
    const done = data.filter(a => a.lastMaintenance && (Date.now() - a.lastMaintenance < 7 * 86400000)).length;
    const critical = data.filter(a => a.kategorie === 'I.' && !a.lastMaintenance).length;
    
    document.getElementById('statCount').textContent = count;
    document.getElementById('statArea').textContent = (area / 1000).toFixed(1) + 'k';
    document.getElementById('statFence').textContent = (fence / 1000).toFixed(1) + 'k';
    document.getElementById('statDone').textContent = done;
    
    document.getElementById('qsCount').textContent = count;
    document.getElementById('qsArea').textContent = (area / 1000).toFixed(1) + 'k';
    document.getElementById('qsCritical').textContent = critical;
    
    updateChart(data);
}

function initChart() {
    const ctx = document.getElementById('statsChart');
    if (!ctx) return;
    
    statsChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Kat. I', 'Kat. II', 'Bez kat.'],
            datasets: [{
                data: [0, 0, 0],
                backgroundColor: ['#ef4444', '#f59e0b', '#64748b']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
}

function updateChart(data) {
    if (!statsChart) return;
    
    const kat1 = data.filter(a => a.kategorie === 'I.').length;
    const kat2 = data.filter(a => a.kategorie === 'II.').length;
    const none = data.filter(a => !a.kategorie).length;
    
    statsChart.data.datasets[0].data = [kat1, kat2, none];
    statsChart.update();
}

// === ROUTING ===
function toggleRouteMode() {
    routeMode = !routeMode;
    const btn = document.getElementById('routeModeBtn');
    const content = document.getElementById('routeContent');
    
    if (routeMode) {
        btn.innerHTML = '<i class="fas fa-stop"></i> Deaktivovat';
        btn.classList.remove('btn-success');
        btn.classList.add('btn-danger');
        content.style.display = 'block';
        showToast('Kliknƒõte na markery pro sestaven√≠ trasy', 'info');
    } else {
        btn.innerHTML = '<i class="fas fa-play"></i> Aktivovat';
        btn.classList.remove('btn-danger');
        btn.classList.add('btn-success');
        content.style.display = 'none';
        clearRoute();
    }
}

function addToRoute(id) {
    const areal = arealData.find(x => x.id === id);
    if (!areal || selectedRoute.find(r => r.id === id)) return;
    
    selectedRoute.push(areal);
    renderRoute();
    showToast(`P≈ôid√°no: ${areal.nazev}`, 'success');
}

function renderRoute() {
    const container = document.getElementById('routeList');
    
    if (selectedRoute.length === 0) {
        container.innerHTML = '<p style="text-align:center;color:var(--text-muted);font-size:13px;">Kliknƒõte na markery pro p≈ôid√°n√≠ do trasy...</p>';
        if (routeLine) map.removeLayer(routeLine);
        return;
    }
    
    container.innerHTML = selectedRoute.map((a, idx) => `
        <div class="route-item">
            <div class="route-num">${idx + 1}</div>
            <div class="route-name">${a.nazev}</div>
            <button class="route-remove" onclick="removeFromRoute(${a.id})">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `).join('');
    
    // V√Ωpoƒçet vzd√°lenosti
    let dist = 0;
    for (let i = 0; i < selectedRoute.length - 1; i++) {
        const p1 = L.latLng(selectedRoute[i].lat, selectedRoute[i].lon);
        const p2 = L.latLng(selectedRoute[i+1].lat, selectedRoute[i+1].lon);
        dist += p1.distanceTo(p2);
    }
    
    const km = (dist / 1000) * 1.3;
    const mins = (km / CONFIG.avgSpeed) * 60;
    
    document.getElementById('routeDistance').textContent = km.toFixed(1);
    document.getElementById('routeTime').textContent = Math.round(mins);
    
    // Vykreslen√≠ ƒç√°ry
    if (routeLine) map.removeLayer(routeLine);
    if (selectedRoute.length > 1) {
        routeLine = L.polyline(selectedRoute.map(a => [a.lat, a.lon]), {
            color: '#0055ff',
            weight: 4,
            dashArray: '10, 10',
            opacity: 0.7
        }).addTo(map);
        map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });
    }
}

function removeFromRoute(id) {
    selectedRoute = selectedRoute.filter(a => a.id !== id);
    renderRoute();
}

function clearRoute() {
    selectedRoute = [];
    renderRoute();
    showToast('Trasa smaz√°na');
}

function optimizeRoute() {
    if (selectedRoute.length < 3) {
        showToast('Pro optimalizaci vyberte alespo≈à 3 body', 'warning');
        return;
    }
    
    // Nearest Neighbor algoritmus
    let unvisited = [...selectedRoute];
    let optimized = [unvisited.shift()];
    
    while (unvisited.length > 0) {
        let last = optimized[optimized.length - 1];
        let nearestIdx = 0;
        let minDist = Infinity;
        
        unvisited.forEach((curr, idx) => {
            let d = L.latLng(last.lat, last.lon).distanceTo(L.latLng(curr.lat, curr.lon));
            if (d < minDist) {
                minDist = d;
                nearestIdx = idx;
            }
        });
        
        optimized.push(unvisited.splice(nearestIdx, 1)[0]);
    }
    
    selectedRoute = optimized;
    renderRoute();
    showToast('Trasa optimalizov√°na', 'success');
}

// === AI PROTOKOL ===
function generateAIProtocol() {
    if (selectedRoute.length === 0) {
        showToast('Vytvo≈ôte trasu', 'warning');
        return;
    }
    
    openAIModal();
    
    // Fallback protokol (bez Gemini API)
    let dist = 0;
    for (let i = 0; i < selectedRoute.length - 1; i++) {
        const p1 = L.latLng(selectedRoute[i].lat, selectedRoute[i].lon);
        const p2 = L.latLng(selectedRoute[i+1].lat, selectedRoute[i+1].lon);
        dist += p1.distanceTo(p2);
    }
    const km = (dist / 1000) * 1.3;
    const mins = (km / CONFIG.avgSpeed) * 60;
    
    let proto = `üìã PROTOKOL √öDR≈ΩBY JVS ${new Date().toLocaleDateString('cs-CZ')}\n`;
    proto += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;
    proto += `üó∫Ô∏è TRASA (${selectedRoute.length} zast√°vek, ${km.toFixed(1)}km, ${mins.toFixed(0)}min)\n\n`;
    
    let currentTime = new Date();
    selectedRoute.forEach((a, i) => {
        const arr = new Date(currentTime);
        const dep = new Date(currentTime.getTime() + 30 * 60000);
        
        proto += `${i+1}. ${a.nazev.padEnd(25)} | ${a.okres.padEnd(12)} | ${a.kategorie || 'N/A'}\n`;
        proto += `   ‚è∞ P≈ô√≠jezd: ${arr.toLocaleTimeString('cs-CZ', {hour:'2-digit',minute:'2-digit'})} | Odjezd: ${dep.toLocaleTimeString('cs-CZ', {hour:'2-digit',minute:'2-digit'})}\n\n`;
        proto += `   üìã KONTROLN√ç SEZNAM:\n`;
        proto += `   ‚òê Kontrola oplocen√≠ (${a.oploceni}bm)\n`;
        proto += `   ‚òê Z√°mky a vstupy\n`;
        proto += `   ‚òê Znaƒçen√≠ a cedule\n`;
        proto += `   ‚òê Vegetace u oplocen√≠\n`;
        proto += `   ‚òê Foto dokumentace\n`;
        proto += `   ‚òê Z√°pis do den√≠ku\n\n`;
        
        if (i < selectedRoute.length - 1) {
            const nextDist = L.latLng(a.lat, a.lon).distanceTo(L.latLng(selectedRoute[i+1].lat, selectedRoute[i+1].lon));
            const nextTime = (nextDist / 1000 * 1.3) / CONFIG.avgSpeed * 60;
            currentTime = new Date(dep.getTime() + nextTime * 60000);
            proto += `   ‚Üí ${selectedRoute[i+1].nazev}: ${(nextDist/1000*1.3).toFixed(1)}km | ${Math.round(nextTime)}min\n\n`;
        }
    });
    
    proto += `\n‚ö†Ô∏è BEZPEƒåNOST:\n`;
    proto += `‚Ä¢ Ochrann√© pom≈Øcky (helma, vesta)\n`;
    proto += `‚Ä¢ Kontrola poƒças√≠\n`;
    proto += `‚Ä¢ Hl√°≈°en√≠ nehod ihned\n`;
    proto += `‚Ä¢ ≈Ω√°dn√© samostatn√© pr√°ce\n\n`;
    proto += `üì¶ MATERI√ÅL: n≈Ø≈æky, svorky, sprej, fotoapar√°t, den√≠k\n`;
    proto += `üë§ Vod√≠ƒç: __________________ | Datum: ${new Date().toLocaleDateString('cs-CZ')}\n`;
    proto += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
    proto += `Vygenerov√°no JVS Ultimate PRO`;
    
    document.getElementById('aiContent').innerHTML = `
        <pre style="background:#f8fafc;padding:16px;border-radius:10px;font-size:12px;font-family:monospace;white-space:pre-wrap;max-height:60vh;overflow-y:auto;">${proto}</pre>
        <button class="btn btn-primary" onclick="downloadPDF()" style="margin-top:16px;">
            <i class="fas fa-download"></i> St√°hnout PDF
        </button>
    `;
    
    window.currentProtocol = proto;
}

function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    doc.setFontSize(16);
    doc.text('PROTOKOL √öDR≈ΩBY JVS', 105, 20, { align: 'center' });
    
    doc.setFontSize(10);
    const lines = doc.splitTextToSize(window.currentProtocol, 180);
    doc.text(lines, 15, 35);
    
    doc.save(`jvs-protokol-${new Date().toISOString().split('T')[0]}.pdf`);
    showToast('Protokol sta≈æen', 'success');
}

// === GPS ===
function toggleGPS() {
    const btn = document.getElementById('gpsFab');
    
    if (userLocation) {
        userLocation = null;
        btn.classList.remove('active');
        showToast('GPS vypnuto');
    } else {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                userLocation = { lat: pos.coords.latitude, lon: pos.coords.longitude };
                map.setView([userLocation.lat, userLocation.lon], 13);
                btn.classList.add('active');
                showToast('GPS aktivov√°no', 'success');
                
                // P≈ôidat marker u≈æivatele
                L.marker([userLocation.lat, userLocation.lon], {
                    icon: L.divIcon({
                        html: '<div style="width:20px;height:20px;background:#10b981;border:3px solid white;border-radius:50%;box-shadow:0 0 0 8px rgba(16,185,129,0.3);"></div>',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    })
                }).addTo(map);
            }, () => {
                showToast('GPS nedostupn√©', 'danger');
            });
        } else {
            showToast('GPS nen√≠ podporov√°no', 'danger');
        }
    }
}

// === EXPORT ===
function exportCSV() {
    let csv = "ID;Nazev;Okres;Kategorie;Vymera;Oploceni;Lat;Lon;Udrzba\n";
    currentFilteredData.forEach(a => {
        csv += `${a.id};${a.nazev};${a.okres};${a.kategorie || ''};${a.vymera};${a.oploceni};${a.lat};${a.lon};${a.lastMaintenance || ''}\n`;
    });
    
    const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.setAttribute("download", `jvs-export-${new Date().toISOString().split('T')[0]}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showToast('CSV exportov√°no', 'success');
}

// === UI HELPERS ===
function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('active');
}

function togglePanel(id) {
    document.getElementById(id).classList.toggle('open');
}

function toggleAddMode() {
    const btn = document.getElementById('addFab');
    btn.classList.toggle('active');
    showToast('Funkce v p≈ô√≠pravƒõ', 'info');
}

function openAIModal() {
    document.getElementById('aiModal').classList.add('active');
}

function closeAIModal() {
    document.getElementById('aiModal').classList.remove('active');
}

function showToast(msg, type = 'info') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = 'toast';
    const icon = type === 'success' ? 'check-circle' : (type === 'danger' ? 'exclamation-triangle' : 'info-circle');
    toast.innerHTML = `<i class="fas fa-${icon}" style="color:var(--${type});"></i> <span>${msg}</span>`;
    container.appendChild(toast);
    
    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 500);
    }, 3000);
}

// === PWA ===
function registerServiceWorker() {
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('data:application/javascript;base64,' + btoa(`
            const CACHE = 'jvs-v1';
            self.addEventListener('install', e => {
                e.waitUntil(caches.open(CACHE).then(c => c.addAll(['/'])));
            });
            self.addEventListener('fetch', e => {
                e.respondWith(caches.match(e.request).then(r => r || fetch(e.request)));
            });
        `)).then(() => console.log('‚úÖ PWA ready')).catch(() => {});
    }
}
</script>

</body>
</html>