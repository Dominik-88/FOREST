<!DOCTYPE html>
<html lang="cs" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<meta name="theme-color" content="#0055ff" id="themeColorMeta">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="description" content="Profesion√°ln√≠ spr√°va vod√°rensk√Ωch are√°l≈Ø s AI asistentem, GPS navigac√≠ a pokroƒçilou analytikou">
<meta name="keywords" content="vod√°rny, management, AI, GPS, routing, optimalizace">
<meta name="author" content="Dominik Schmied">
<meta property="og:title" content="JVS Ultimate PRO | AI Management System">
<meta property="og:description" content="Profesion√°ln√≠ spr√°va vod√°rensk√Ωch are√°l≈Ø s AI asistentem">
<meta property="og:type" content="website">
<meta property="og:url" content="https://dominik-88.github.io/FOREST/">
<meta property="og:image" content="https://dominik-88.github.io/FOREST/og-image.png">
<meta name="twitter:card" content="summary_large_image">
<title>JVS Ultimate PRO | AI Management System</title>
<link rel="canonical" href="https://dominik-88.github.io/FOREST/">
<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%230055ff'/%3E%3Ctext x='50' y='55' font-size='50' fill='white' text-anchor='middle'%3EJ%3C/text%3E%3C/svg%3E">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.css">
<link rel="stylesheet" href="https://unpkg.com/aos@2.3.4/dist/aos.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
<style>
:root[data-theme="light"]{--primary:#0055ff;--primary-dark:#0044cc;--accent:#7c3aed;--success:#10b981;--danger:#ef4444;--warning:#f59e0b;--secondary:#64748b;--bg:#f1f5f9;--bg-glass:rgba(255,255,255,0.95);--text-dark:#1e293b;--text-muted:#64748b;--border:#e2e8f0;}
:root[data-theme="dark"]{--primary:#4c8cff;--primary-dark:#3a7ae8;--accent:#a855f7;--success:#34d399;--danger:#f87171;--warning:#fbbf24;--secondary:#94a3b8;--bg:#0f172a;--bg-glass:rgba(15,23,42,0.95);--text-dark:#f1f5f9;--text-muted:#94a3b8;--border:#334155;}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{font-family:'Inter',sans-serif;overflow:hidden;height:100vh;width:100vw;color:var(--text-dark);background:var(--bg);transition:background 0.3s,color 0.3s;}
#mapWrapper{position:fixed;top:0;left:0;right:0;bottom:0;z-index:0;}
#map{height:100%;width:100%;background:#e5e7eb;}
.fab{pointer-events:auto;position:fixed;width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:none;font-size:22px;box-shadow:0 10px 15px -3px rgb(0 0 0/0.1);transition:all 0.3s cubic-bezier(0.4,0,0.2,1);z-index:1100;backdrop-filter:blur(16px);cursor:pointer;}
.fab:hover{transform:scale(1.1);}.fab:active{transform:scale(0.95);}
.menu-fab{top:20px;left:20px;background:var(--primary);color:white;}
.add-fab{top:20px;right:20px;background:var(--success);color:white;}
.add-fab.active{background:var(--danger);transform:rotate(45deg);}
.ai-fab{bottom:90px;right:20px;background:var(--accent);color:white;animation:pulse-ai 2s infinite;}
.gps-fab{bottom:160px;right:20px;background:var(--warning);color:white;}
.gps-fab.active{background:var(--success);animation:pulse-gps 1.5s infinite;}
.theme-fab{bottom:230px;right:20px;background:var(--secondary);color:white;}
@keyframes pulse-ai{0%,100%{box-shadow:0 0 0 0 rgba(124,58,237,0.7);}50%{box-shadow:0 0 0 15px rgba(124,58,237,0);}}
@keyframes pulse-gps{0%,100%{box-shadow:0 0 0 0 rgba(16,185,129,0.7);}50%{box-shadow:0 0 0 12px rgba(16,185,129,0);}}
.quick-stats{pointer-events:auto;position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:var(--bg-glass);backdrop-filter:blur(16px);padding:14px 32px;border-radius:50px;box-shadow:0 10px 15px -3px rgb(0 0 0/0.1);display:flex;gap:28px;z-index:900;border:1px solid var(--border);}
.qs-item{display:flex;flex-direction:column;align-items:center;gap:4px;}
.qs-val{font-size:20px;font-weight:800;color:var(--primary);}
.qs-lbl{font-size:10px;color:var(--text-muted);font-weight:600;text-transform:uppercase;}
.sidebar{pointer-events:auto;position:fixed;top:0;left:0;bottom:0;width:420px;max-width:90vw;background:var(--bg-glass);backdrop-filter:blur(16px);box-shadow:10px 0 40px rgba(0,0,0,0.12);transform:translateX(-100%);transition:transform 0.4s cubic-bezier(0.4,0,0.2,1);z-index:1050;display:flex;flex-direction:column;border-right:1px solid var(--border);}
.sidebar.active{transform:translateX(0);}
.sidebar-header{padding:28px 24px;background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);color:white;}
.brand-row{display:flex;justify-content:space-between;align-items:center;}
.app-brand{display:flex;align-items:center;gap:14px;}
.brand-icon{width:48px;height:48px;background:rgba(255,255,255,0.2);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:900;backdrop-filter:blur(10px);border:2px solid rgba(255,255,255,0.3);}
.brand-text h1{font-size:22px;font-weight:800;margin-bottom:2px;}
.brand-text p{font-size:11px;opacity:0.85;font-weight:500;}
.close-sidebar{background:rgba(255,255,255,0.15);border:none;color:white;width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;transition:all 0.3s;cursor:pointer;}
.close-sidebar:hover{background:rgba(255,255,255,0.25);}
.sidebar-content{overflow-y:auto;flex:1;padding:20px;}
.panel-section{background:var(--bg-glass);border-radius:14px;margin-bottom:16px;border:1px solid var(--border);overflow:hidden;transition:all 0.3s;}
.panel-head{padding:18px 20px;font-weight:700;font-size:14px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;color:var(--text-dark);background:var(--bg);}
.panel-head:hover{opacity:0.8;}
.panel-head .chevron{transition:transform 0.3s;color:var(--text-muted);}
.panel-section.open .chevron{transform:rotate(180deg);}
.panel-body{max-height:0;overflow:hidden;opacity:0;transition:all 0.4s cubic-bezier(0.4,0,0.2,1);}
.panel-section.open .panel-body{max-height:3000px;padding:20px;opacity:1;}
.form-group{margin-bottom:16px;}
.form-label{display:block;font-size:11px;font-weight:700;color:var(--text-muted);margin-bottom:8px;text-transform:uppercase;}
.form-input,.form-select{width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:10px;font-size:14px;background:var(--bg);transition:all 0.3s;color:var(--text-dark);}
.form-input:focus,.form-select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 4px rgba(0,85,255,0.08);}
.form-input.error{border-color:var(--danger);animation:shake 0.3s;}
@keyframes shake{0%,100%{transform:translateX(0);}25%{transform:translateX(-5px);}75%{transform:translateX(5px);}}
.error-msg{color:var(--danger);font-size:11px;margin-top:4px;display:none;}
.form-input.error + .error-msg{display:block;}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 20px;border-radius:10px;border:none;font-weight:600;font-size:14px;transition:all 0.3s;width:100%;cursor:pointer;}
.btn-primary{background:var(--primary);color:white;}
.btn-primary:hover{background:var(--primary-dark);transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,85,255,0.3);}
.btn-success{background:var(--success);color:white;}
.btn-danger{background:var(--danger);color:white;}
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.stat-item{background:var(--bg);padding:16px;border-radius:12px;border:1px solid var(--border);text-align:center;}
.stat-val{font-size:24px;font-weight:800;color:var(--primary);display:block;}
.stat-lbl{font-size:10px;color:var(--text-muted);font-weight:600;text-transform:uppercase;}
.toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:white;padding:12px 24px;border-radius:50px;box-shadow:0 10px 15px -3px rgb(0 0 0/0.1);display:flex;align-items:center;gap:12px;z-index:9999;animation:slideIn 0.3s ease-out;}
@keyframes slideIn{from{transform:translate(-50%,-20px);opacity:0;}to{transform:translate(-50%,0);opacity:1;}}
.modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);backdrop-filter:blur(8px);z-index:2000;display:none;align-items:center;justify-content:center;padding:20px;}
.modal.active{display:flex;}
.modal-card{background:var(--bg-glass);border-radius:14px;max-width:500px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 10px 15px -3px rgb(0 0 0/0.1);}
.modal-header{padding:24px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;}
.modal-title{font-size:20px;font-weight:800;color:var(--text-dark);}
.modal-close{background:none;border:none;font-size:28px;color:var(--text-muted);cursor:pointer;width:36px;height:36px;display:flex;align-items:center;justify-content:center;border-radius:8px;transition:all 0.3s;}
.modal-close:hover{background:var(--bg);color:var(--danger);}
.modal-body{padding:24px;}
.route-list{display:flex;flex-direction:column;gap:8px;margin-top:12px;}
.route-item{background:var(--bg);padding:12px;border-radius:10px;display:flex;align-items:center;gap:12px;border:1px solid var(--border);cursor:move;}
.route-item:hover{box-shadow:0 10px 15px -3px rgb(0 0 0/0.1);}
.route-num{width:32px;height:32px;background:var(--primary);color:white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:14px;}
.route-name{flex:1;font-weight:600;font-size:14px;}
.route-remove{background:none;border:none;color:var(--danger);cursor:pointer;padding:6px;border-radius:6px;transition:all 0.3s;}
.route-remove:hover{background:#fee2e2;}
.chart-container{position:relative;height:250px;margin-top:16px;}
@media (max-width:768px){.sidebar{width:100%;}.quick-stats{bottom:16px;gap:16px;padding:10px 20px;width:90vw;}.qs-lbl{display:none;}}
</style>
</head>
<body>

<main id="app">
<section id="mapWrapper" aria-label="Mapa are√°l≈Ø">
    <div id="map" role="application" aria-label="Interaktivn√≠ mapa vod√°rensk√Ωch are√°l≈Ø"></div>
</section>

<nav aria-label="Hlavn√≠ navigace">
<button class="fab menu-fab" id="menuBtn" aria-label="Otev≈ô√≠t menu">
    <i class="fas fa-bars"></i>
</button>
<button class="fab add-fab" id="addBtn" aria-label="P≈ôidat are√°l">
    <i class="fas fa-plus"></i>
</button>
<button class="fab ai-fab" id="aiBtn" aria-label="AI Asistent">
    <i class="fas fa-robot"></i>
</button>
<button class="fab gps-fab" id="gpsBtn" aria-label="GPS Tracking">
    <i class="fas fa-location-crosshairs"></i>
</button>
<button class="fab theme-fab" id="themeBtn" aria-label="P≈ôepnout t√©ma">
    <i class="fas fa-moon"></i>
</button>
</nav>

<aside class="quick-stats" data-aos="fade-up" data-aos-delay="200">
    <div class="qs-item">
        <span class="qs-val" id="qsCount">0</span>
        <span class="qs-lbl">Are√°ly</span>
    </div>
    <div style="width:1px;height:32px;background:var(--border);"></div>
    <div class="qs-item">
        <span class="qs-val" id="qsArea">0</span>
        <span class="qs-lbl">m¬≤</span>
    </div>
    <div style="width:1px;height:32px;background:var(--border);"></div>
    <div class="qs-item">
        <span class="qs-val" id="qsCritical" style="color:var(--danger);">0</span>
        <span class="qs-lbl">Kritick√©</span>
    </div>
</aside>

<aside class="sidebar" id="sidebar" role="complementary">
    <header class="sidebar-header">
        <div class="brand-row">
            <div class="app-brand">
                <div class="brand-icon" aria-hidden="true">J</div>
                <div class="brand-text">
                    <h1 id="appName">JVS Ultimate PRO</h1>
                    <p id="appDesc">AI Management System</p>
                </div>
            </div>
            <button class="close-sidebar" id="closeSidebarBtn" aria-label="Zav≈ô√≠t menu">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>
    </header>

    <div class="sidebar-content">
        <section class="panel-section open" id="panelFilters" data-aos="fade-right">
            <div class="panel-head" data-panel="panelFilters">
                <span><i class="fas fa-filter"></i> Filtry</span>
                <i class="fas fa-chevron-down chevron"></i>
            </div>
            <div class="panel-body">
                <div class="form-group">
                    <label class="form-label" for="searchInput">Vyhled√°v√°n√≠</label>
                    <input type="text" class="form-input" id="searchInput" placeholder="N√°zev nebo okres..." aria-label="Vyhledat are√°l">
                    <span class="error-msg">Zadejte alespo≈à 2 znaky</span>
                </div>
                <div class="stats-grid">
                    <div class="form-group">
                        <label class="form-label" for="okresFilter">Okres</label>
                        <select class="form-select" id="okresFilter" aria-label="Filtrovat podle okresu">
                            <option value="all">V≈°echny</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="katFilter">Kategorie</label>
                        <select class="form-select" id="katFilter" aria-label="Filtrovat podle kategorie">
                            <option value="all">V≈°echny</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary" id="resetFiltersBtn">
                    <i class="fas fa-undo"></i> Reset
                </button>
            </div>
        </section>

        <section class="panel-section" id="panelStats" data-aos="fade-right" data-aos-delay="100">
            <div class="panel-head" data-panel="panelStats">
                <span><i class="fas fa-chart-line"></i> Statistiky</span>
                <i class="fas fa-chevron-down chevron"></i>
            </div>
            <div class="panel-body">
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-val" id="statCount">0</span>
                        <span class="stat-lbl">Are√°ly</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-val" id="statArea">0</span>
                        <span class="stat-lbl">m¬≤</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-val" id="statFence">0</span>
                        <span class="stat-lbl">Ploty (bm)</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-val" id="statDone" style="color:var(--success);">0</span>
                        <span class="stat-lbl">Hotovo (7d)</span>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="statsChart" aria-label="Graf statistik"></canvas>
                </div>
                <button class="btn btn-primary" id="exportCSVBtn" style="margin-top:16px;">
                    <i class="fas fa-file-csv"></i> Export CSV
                </button>
            </div>
        </section>

        <section class="panel-section" id="panelRoute" data-aos="fade-right" data-aos-delay="200">
            <div class="panel-head" data-panel="panelRoute">
                <span><i class="fas fa-route"></i> Pl√°novaƒç tras</span>
                <i class="fas fa-chevron-down chevron"></i>
            </div>
            <div class="panel-body">
                <div class="form-group">
                    <label class="form-label">Re≈æim pl√°nov√°n√≠</label>
                    <button class="btn btn-success" id="routeModeBtn">
                        <i class="fas fa-play"></i> Aktivovat
                    </button>
                </div>
                <div id="routeContent" style="display:none;">
                    <div class="route-list" id="routeList">
                        <p style="text-align:center;color:var(--text-muted);font-size:13px;">Kliknƒõte na markery pro p≈ôid√°n√≠ do trasy...</p>
                    </div>
                    <div class="stats-grid" style="margin-top:16px;">
                        <div class="stat-item">
                            <span class="stat-val" id="routeDistance">0</span>
                            <span class="stat-lbl">KM</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-val" id="routeTime">0</span>
                            <span class="stat-lbl">MIN</span>
                        </div>
                    </div>
                    <div style="display:flex;gap:8px;margin-top:12px;">
                        <button class="btn btn-success" id="optimizeRouteBtn" style="flex:2;">
                            <i class="fas fa-wand-magic-sparkles"></i> Optimalizovat
                        </button>
                        <button class="btn btn-danger" id="clearRouteBtn" style="flex:1;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <button class="btn btn-primary" id="generateProtocolBtn" style="margin-top:8px;">
                        <i class="fas fa-robot"></i> AI Protokol
                    </button>
                </div>
            </div>
        </section>
    </div>
</aside>

<div class="modal" id="aiModal" role="dialog" aria-labelledby="aiModalTitle" aria-modal="true">
    <div class="modal-card">
        <header class="modal-header">
            <h2 class="modal-title" id="aiModalTitle">ü§ñ AI Protokol</h2>
            <button class="modal-close" id="closeAIModalBtn" aria-label="Zav≈ô√≠t">√ó</button>
        </header>
        <div class="modal-body" id="aiContent">
            <p style="text-align:center;color:var(--text-muted);">Generuji protokol...</p>
        </div>
    </div>
</div>

<div id="toastContainer" aria-live="polite" aria-atomic="true"></div>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://unpkg.com/aos@2.3.4/dist/aos.js"></script>

<script>
'use strict';

class JVSApp {
    constructor() {
        this.config = null;
        this.arealData = [];
        this.map = null;
        this.markerCluster = null;
        this.selectedRoute = [];
        this.routeMode = false;
        this.routeLine = null;
        this.currentFilteredData = [];
        this.statsChart = null;
        this.userLocation = null;
        this.theme = localStorage.getItem('jvs_theme') || 'light';
        this.init();
    }

    async init() {
        try {
            await this.loadConfig();
            await this.loadArealData();
            this.initTheme();
            this.initMap();
            this.createMarkers(this.arealData);
            this.updateStats(this.arealData);
            this.initChart();
            this.initEventListeners();
            this.registerServiceWorker();
            AOS.init({ duration: 600, once: true });
            console.log('‚úÖ JVS Ultimate PRO initialized');
        } catch (error) {
            console.error('‚ùå Initialization error:', error);
            this.showToast('Chyba p≈ôi inicializaci aplikace', 'danger');
        }
    }

    async loadConfig() {
        try {
            const response = await fetch('config.json');
            this.config = await response.json();
            document.getElementById('appName').textContent = this.config.app.name;
            document.getElementById('appDesc').textContent = this.config.app.description;
            this.populateFilters();
        } catch (error) {
            console.error('Config load error:', error);
            this.config = this.getDefaultConfig();
        }
    }

    async loadArealData() {
        try {
            const response = await fetch('data/areals.json');
            this.arealData = await response.json();
            const saved = localStorage.getItem(this.config?.storage?.key || 'jvs_ultimate_v2');
            if (saved) {
                const parsed = JSON.parse(saved);
                this.arealData = this.arealData.map(d => {
                    const s = parsed.find(x => x.id === d.id);
                    return s ? { ...d, ...s } : d;
                });
            }
        } catch (error) {
            console.error('Data load error:', error);
            this.arealData = [];
        }
    }

    populateFilters() {
        const okresSelect = document.getElementById('okresFilter');
        const katSelect = document.getElementById('katFilter');
        
        if (this.config?.okresy) {
            this.config.okresy.forEach(o => {
                const opt = document.createElement('option');
                opt.value = o.code;
                opt.textContent = o.name;
                okresSelect.appendChild(opt);
            });
        }
        
        if (this.config?.kategorie) {
            this.config.kategorie.forEach(k => {
                const opt = document.createElement('option');
                opt.value = k.code;
                opt.textContent = k.name;
                katSelect.appendChild(opt);
            });
        }
    }

    initTheme() {
        document.documentElement.setAttribute('data-theme', this.theme);
        const icon = document.querySelector('#themeBtn i');
        icon.className = this.theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        const metaTheme = document.getElementById('themeColorMeta');
        metaTheme.content = this.theme === 'dark' ? '#0f172a' : '#0055ff';
    }

    toggleTheme() {
        this.theme = this.theme === 'light' ? 'dark' : 'light';
        localStorage.setItem('jvs_theme', this.theme);
        this.initTheme();
        this.showToast(`T√©ma: ${this.theme === 'dark' ? 'Tmav√©' : 'Svƒõtl√©'}`, 'info');
    }

    initMap() {
        const center = this.config?.map?.defaultCenter || [49.15, 14.35];
        const zoom = this.config?.map?.defaultZoom || 10;
        
        this.map = L.map('map', { zoomControl: false }).setView(center, zoom);
        
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '¬© OpenStreetMap'
        }).addTo(this.map);
        
        L.control.zoom({ position: 'bottomright' }).addTo(this.map);
        
        this.markerCluster = L.markerClusterGroup({
            maxClusterRadius: this.config?.map?.clusterRadius || 40,
            iconCreateFunction: cluster => L.divIcon({
                html: `<div style="background:var(--primary);color:white;border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center;font-weight:bold;border:3px solid white;box-shadow:0 10px 15px -3px rgb(0 0 0/0.1);">${cluster.getChildCount()}</div>`,
                className: 'cluster-icon',
                iconSize: L.point(40, 40)
            })
        });
        this.map.addLayer(this.markerCluster);
    }

    getMarkerColor(areal) {
        const maintenanceDays = this.config?.storage?.maintenanceDays || 7;
        if (areal.lastMaintenance && (Date.now() - areal.lastMaintenance < maintenanceDays * 86400000)) {
            return this.config?.ui?.theme?.light?.success || '#10b981';
        }
        const kategorie = this.config?.kategorie?.find(k => k.code === areal.kategorie);
        return kategorie?.color || '#64748b';
    }

    createMarkers(data) {
        this.markerCluster.clearLayers();
        
        data.forEach(areal => {
            const color = this.getMarkerColor(areal);
            const icon = L.divIcon({
                className: 'marker-container',
                html: `<div style="width:32px;height:32px;border-radius:50% 50% 50% 0;transform:rotate(-45deg);background:${color};border:3px solid white;box-shadow:0 4px 10px rgba(0,0,0,0.2);"><div style="width:12px;height:12px;background:white;border-radius:50%;margin:7px 0 0 7px;"></div></div>`,
                iconSize: [32, 42],
                iconAnchor: [16, 42]
            });
            
            const marker = L.marker([areal.lat, areal.lon], { icon });
            
            marker.on('click', () => {
                if (this.routeMode) {
                    this.addToRoute(areal.id);
                } else {
                    marker.bindPopup(this.generatePopup(areal)).openPopup();
                }
            });
            
            this.markerCluster.addLayer(marker);
        });
        
        this.currentFilteredData = data;
    }

    generatePopup(areal) {
        return `
            <div style="min-width:220px;">
                <h3 style="margin-bottom:8px;border-bottom:2px solid #f1f5f9;padding-bottom:4px;">${areal.nazev}</h3>
                <p><strong>Kat:</strong> ${areal.kategorie || 'Nen√≠'} | <strong>Okres:</strong> ${areal.okres}</p>
                <p><strong>V√Ωmƒõra:</strong> ${areal.vymera.toLocaleString()} m¬≤</p>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:12px;">
                    <button class="btn btn-primary" onclick="app.toggleMaintenance(${areal.id})" style="padding:8px;font-size:12px;">
                        <i class="fas fa-check"></i> Hotovo
                    </button>
                    <a href="https://www.google.com/maps/dir/?api=1&destination=${areal.lat},${areal.lon}" target="_blank" rel="noopener noreferrer"
                       style="display:flex;align-items:center;justify-content:center;padding:8px;background:#e2e8f0;border-radius:10px;text-decoration:none;color:var(--text-dark);font-weight:600;font-size:12px;">
                       <i class="fas fa-location-arrow"></i>
                    </a>
                </div>
            </div>
        `;
    }

    toggleMaintenance(id) {
        const index = this.arealData.findIndex(x => x.id === id);
        if (index === -1) return;
        
        const current = this.arealData[index].lastMaintenance;
        if (current && (Date.now() - current < 86400000)) {
            this.arealData[index].lastMaintenance = null;
            this.showToast('√ödr≈æba zru≈°ena', 'info');
        } else {
            this.arealData[index].lastMaintenance = Date.now();
            this.showToast('√ödr≈æba zaznamen√°na', 'success');
        }
        
        this.saveData();
        this.applyFilters();
        this.map.closePopup();
    }

    applyFilters() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const okres = document.getElementById('okresFilter').value;
        const kat = document.getElementById('katFilter').value;
        
        if (search.length > 0 && search.length < 2) {
            document.getElementById('searchInput').classList.add('error');
            return;
        } else {
            document.getElementById('searchInput').classList.remove('error');
        }
        
        const filtered = this.arealData.filter(a => {
            const matchSearch = !search || a.nazev.toLowerCase().includes(search) || a.okres.toLowerCase().includes(search);
            const matchOkres = okres === 'all' || a.okres === okres;
            const matchKat = kat === 'all' || (kat === 'none' ? !a.kategorie : a.kategorie === kat);
            return matchSearch && matchOkres && matchKat;
        });
        
        this.createMarkers(filtered);
        this.updateStats(filtered);
    }

    resetFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('okresFilter').value = 'all';
        document.getElementById('katFilter').value = 'all';
        this.applyFilters();
        this.showToast('Filtry resetov√°ny');
    }

    updateStats(data) {
        const count = data.length;
        const area = data.reduce((sum, a) => sum + a.vymera, 0);
        const fence = data.reduce((sum, a) => sum + a.oploceni, 0);
        const maintenanceDays = this.config?.storage?.maintenanceDays || 7;
        const done = data.filter(a => a.lastMaintenance && (Date.now() - a.lastMaintenance < maintenanceDays * 86400000)).length;
        const critical = data.filter(a => a.kategorie === 'I.' && !a.lastMaintenance).length;
        
        document.getElementById('statCount').textContent = count;
        document.getElementById('statArea').textContent = (area / 1000).toFixed(1) + 'k';
        document.getElementById('statFence').textContent = (fence / 1000).toFixed(1) + 'k';
        document.getElementById('statDone').textContent = done;
        
        document.getElementById('qsCount').textContent = count;
        document.getElementById('qsArea').textContent = (area / 1000).toFixed(1) + 'k';
        document.getElementById('qsCritical').textContent = critical;
        
        this.updateChart(data);
    }

    initChart() {
        const ctx = document.getElementById('statsChart');
        if (!ctx) return;
        
        this.statsChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Kat. I', 'Kat. II', 'Bez kat.'],
                datasets: [{
                    data: [0, 0, 0],
                    backgroundColor: ['#ef4444', '#f59e0b', '#64748b']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }

    updateChart(data) {
        if (!this.statsChart) return;
        
        const kat1 = data.filter(a => a.kategorie === 'I.').length;
        const kat2 = data.filter(a => a.kategorie === 'II.').length;
        const none = data.filter(a => !a.kategorie).length;
        
        this.statsChart.data.datasets[0].data = [kat1, kat2, none];
        this.statsChart.update();
    }

    toggleRouteMode() {
        this.routeMode = !this.routeMode;
        const btn = document.getElementById('routeModeBtn');
        const content = document.getElementById('routeContent');
        
        if (this.routeMode) {
            btn.innerHTML = '<i class="fas fa-stop"></i> Deaktivovat';
            btn.classList.remove('btn-success');
            btn.classList.add('btn-danger');
            content.style.display = 'block';
            this.showToast('Kliknƒõte na markery pro sestaven√≠ trasy', 'info');
        } else {
            btn.innerHTML = '<i class="fas fa-play"></i> Aktivovat';
            btn.classList.remove('btn-danger');
            btn.classList.add('btn-success');
            content.style.display = 'none';
            this.clearRoute();
        }
    }

    addToRoute(id) {
        const areal = this.arealData.find(x => x.id === id);
        if (!areal || this.selectedRoute.find(r => r.id === id)) return;
        
        this.selectedRoute.push(areal);
        this.renderRoute();
        this.showToast(`P≈ôid√°no: ${areal.nazev}`, 'success');
    }

    renderRoute() {
        const container = document.getElementById('routeList');
        
        if (this.selectedRoute.length === 0) {
            container.innerHTML = '<p style="text-align:center;color:var(--text-muted);font-size:13px;">Kliknƒõte na markery pro p≈ôid√°n√≠ do trasy...</p>';
            if (this.routeLine) this.map.removeLayer(this.routeLine);
            return;
        }
        
        container.innerHTML = this.selectedRoute.map((a, idx) => `
            <div class="route-item">
                <div class="route-num">${idx + 1}</div>
                <div class="route-name">${a.nazev}</div>
                <button class="route-remove" onclick="app.removeFromRoute(${a.id})">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `).join('');
        
        let dist = 0;
        for (let i = 0; i < this.selectedRoute.length - 1; i++) {
            const p1 = L.latLng(this.selectedRoute[i].lat, this.selectedRoute[i].lon);
            const p2 = L.latLng(this.selectedRoute[i + 1].lat, this.selectedRoute[i + 1].lon);
            dist += p1.distanceTo(p2);
        }
        
        const roadCoef = this.config?.routing?.roadCoefficient || 1.3;
        const avgSpeed = this.config?.routing?.avgSpeed || 50;
        const km = (dist / 1000) * roadCoef;
        const mins = (km / avgSpeed) * 60;
        
        document.getElementById('routeDistance').textContent = km.toFixed(1);
        document.getElementById('routeTime').textContent = Math.round(mins);
        
        if (this.routeLine) this.map.removeLayer(this.routeLine);
        if (this.selectedRoute.length > 1) {
            this.routeLine = L.polyline(this.selectedRoute.map(a => [a.lat, a.lon]), {
                color: '#0055ff',
                weight: 4,
                dashArray: '10, 10',
                opacity: 0.7
            }).addTo(this.map);
            this.map.fitBounds(this.routeLine.getBounds(), { padding: [50, 50] });
        }
    }

    removeFromRoute(id) {
        this.selectedRoute = this.selectedRoute.filter(a => a.id !== id);
        this.renderRoute();
    }

    clearRoute() {
        this.selectedRoute = [];
        this.renderRoute();
        this.showToast('Trasa smaz√°na');
    }

    optimizeRoute() {
        if (this.selectedRoute.length < 3) {
            this.showToast('Pro optimalizaci vyberte alespo≈à 3 body', 'warning');
            return;
        }
        
        let unvisited = [...this.selectedRoute];
        let optimized = [unvisited.shift()];
        
        while (unvisited.length > 0) {
            let last = optimized[optimized.length - 1];
            let nearestIdx = 0;
            let minDist = Infinity;
            
            unvisited.forEach((curr, idx) => {
                let d = L.latLng(last.lat, last.lon).distanceTo(L.latLng(curr.lat, curr.lon));
                if (d < minDist) {
                    minDist = d;
                    nearestIdx = idx;
                }
            });
            
            optimized.push(unvisited.splice(nearestIdx, 1)[0]);
        }
        
        this.selectedRoute = optimized;
        this.renderRoute();
        this.showToast('Trasa optimalizov√°na', 'success');
    }

    generateAIProtocol() {
        if (this.selectedRoute.length === 0) {
            this.showToast('Vytvo≈ôte trasu', 'warning');
            return;
        }
        
        this.openAIModal();
        
        let dist = 0;
        for (let i = 0; i < this.selectedRoute.length - 1; i++) {
            const p1 = L.latLng(this.selectedRoute[i].lat, this.selectedRoute[i].lon);
            const p2 = L.latLng(this.selectedRoute[i + 1].lat, this.selectedRoute[i + 1].lon);
            dist += p1.distanceTo(p2);
        }
        const roadCoef = this.config?.routing?.roadCoefficient || 1.3;
        const avgSpeed = this.config?.routing?.avgSpeed || 50;
        const maintenanceTime = this.config?.routing?.maintenanceTime || 30;
        const km = (dist / 1000) * roadCoef;
        const mins = (km / avgSpeed) * 60;
        
        let proto = `üìã PROTOKOL √öDR≈ΩBY JVS ${new Date().toLocaleDateString('cs-CZ')}\n`;
        proto += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;
        proto += `üó∫Ô∏è TRASA (${this.selectedRoute.length} zast√°vek, ${km.toFixed(1)}km, ${mins.toFixed(0)}min)\n\n`;
        
        let currentTime = new Date();
        this.selectedRoute.forEach((a, i) => {
            const arr = new Date(currentTime);
            const dep = new Date(currentTime.getTime() + maintenanceTime * 60000);
            
            proto += `${i + 1}. ${a.nazev.padEnd(25)} | ${a.okres.padEnd(12)} | ${a.kategorie || 'N/A'}\n`;
            proto += `   ‚è∞ P≈ô√≠jezd: ${arr.toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' })} | Odjezd: ${dep.toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' })}\n\n`;
            proto += `   üìã KONTROLN√ç SEZNAM:\n`;
            proto += `   ‚òê Kontrola oplocen√≠ (${a.oploceni}bm)\n`;
            proto += `   ‚òê Z√°mky a vstupy\n`;
            proto += `   ‚òê Znaƒçen√≠ a cedule\n`;
            proto += `   ‚òê Vegetace u oplocen√≠\n`;
            proto += `   ‚òê Foto dokumentace\n`;
            proto += `   ‚òê Z√°pis do den√≠ku\n\n`;
            
            if (i < this.selectedRoute.length - 1) {
                const nextDist = L.latLng(a.lat, a.lon).distanceTo(L.latLng(this.selectedRoute[i + 1].lat, this.selectedRoute[i + 1].lon));
                const nextTime = (nextDist / 1000 * roadCoef) / avgSpeed * 60;
                currentTime = new Date(dep.getTime() + nextTime * 60000);
                proto += `   ‚Üí ${this.selectedRoute[i + 1].nazev}: ${(nextDist / 1000 * roadCoef).toFixed(1)}km | ${Math.round(nextTime)}min\n\n`;
            }
        });
        
        proto += `\n‚ö†Ô∏è BEZPEƒåNOST:\n`;
        proto += `‚Ä¢ Ochrann√© pom≈Øcky (helma, vesta)\n`;
        proto += `‚Ä¢ Kontrola poƒças√≠\n`;
        proto += `‚Ä¢ Hl√°≈°en√≠ nehod ihned\n`;
        proto += `‚Ä¢ ≈Ω√°dn√© samostatn√© pr√°ce\n\n`;
        proto += `üì¶ MATERI√ÅL: n≈Ø≈æky, svorky, sprej, fotoapar√°t, den√≠k\n`;
        proto += `üë§ Vod√≠ƒç: __________________ | Datum: ${new Date().toLocaleDateString('cs-CZ')}\n`;
        proto += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
        proto += `Vygenerov√°no ${this.config?.app?.name || 'JVS Ultimate PRO'}`;
        
        document.getElementById('aiContent').innerHTML = `
            <pre style="background:var(--bg);padding:16px;border-radius:10px;font-size:12px;font-family:monospace;white-space:pre-wrap;max-height:60vh;overflow-y:auto;">${proto}</pre>
            <button class="btn btn-primary" onclick="app.downloadPDF()" style="margin-top:16px;">
                <i class="fas fa-download"></i> St√°hnout PDF
            </button>
        `;
        
        window.currentProtocol = proto;
    }

    downloadPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFontSize(16);
        doc.text('PROTOKOL √öDR≈ΩBY JVS', 105, 20, { align: 'center' });
        
        doc.setFontSize(10);
        const lines = doc.splitTextToSize(window.currentProtocol, 180);
        doc.text(lines, 15, 35);
        
        doc.save(`jvs-protokol-${new Date().toISOString().split('T')[0]}.pdf`);
        this.showToast('Protokol sta≈æen', 'success');
    }

    toggleGPS() {
        const btn = document.getElementById('gpsBtn');
        
        if (this.userLocation) {
            this.userLocation = null;
            btn.classList.remove('active');
            this.showToast('GPS vypnuto');
        } else {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    this.userLocation = { lat: pos.coords.latitude, lon: pos.coords.longitude };
                    this.map.setView([this.userLocation.lat, this.userLocation.lon], 13);
                    btn.classList.add('active');
                    this.showToast('GPS aktivov√°no', 'success');
                    
                    L.marker([this.userLocation.lat, this.userLocation.lon], {
                        icon: L.divIcon({
                            html: '<div style="width:20px;height:20px;background:#10b981;border:3px solid white;border-radius:50%;box-shadow:0 0 0 8px rgba(16,185,129,0.3);"></div>',
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        })
                    }).addTo(this.map);
                }, () => {
                    this.showToast('GPS nedostupn√©', 'danger');
                });
            } else {
                this.showToast('GPS nen√≠ podporov√°no', 'danger');
            }
        }
    }

    exportCSV() {
        let csv = "ID;Nazev;Okres;Kategorie;Vymera;Oploceni;Lat;Lon;Udrzba\n";
        this.currentFilteredData.forEach(a => {
            csv += `${a.id};${a.nazev};${a.okres};${a.kategorie || ''};${a.vymera};${a.oploceni};${a.lat};${a.lon};${a.lastMaintenance || ''}\n`;
        });
        
        const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.setAttribute("download", `jvs-export-${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        this.showToast('CSV exportov√°no', 'success');
    }

    toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('active');
    }

    togglePanel(id) {
        document.getElementById(id).classList.toggle('open');
    }

    toggleAddMode() {
        const btn = document.getElementById('addBtn');
        btn.classList.toggle('active');
        this.showToast('Funkce v p≈ô√≠pravƒõ', 'info');
    }

    openAIModal() {
        document.getElementById('aiModal').classList.add('active');
    }

    closeAIModal() {
        document.getElementById('aiModal').classList.remove('active');
    }

    showToast(msg, type = 'info') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = 'toast';
        const icon = type === 'success' ? 'check-circle' : (type === 'danger' ? 'exclamation-triangle' : 'info-circle');
        toast.innerHTML = `<i class="fas fa-${icon}" style="color:var(--${type});"></i> <span>${msg}</span>`;
        container.appendChild(toast);
        
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 500);
        }, 3000);
    }

    saveData() {
        const key = this.config?.storage?.key || 'jvs_ultimate_v2';
        localStorage.setItem(key, JSON.stringify(this.arealData));
    }

    getDefaultConfig() {
        return {
            app: { name: 'JVS Ultimate PRO', description: 'AI Management System' },
            map: { defaultCenter: [49.15, 14.35], defaultZoom: 10, clusterRadius: 40 },
            routing: { avgSpeed: 50, roadCoefficient: 1.3, maintenanceTime: 30 },
            storage: { key: 'jvs_ultimate_v2', maintenanceDays: 7 }
        };
    }

    initEventListeners() {
        document.getElementById('menuBtn').addEventListener('click', () => this.toggleSidebar());
        document.getElementById('closeSidebarBtn').addEventListener('click', () => this.toggleSidebar());
        document.getElementById('addBtn').addEventListener('click', () => this.toggleAddMode());
        document.getElementById('aiBtn').addEventListener('click', () => this.openAIModal());
        document.getElementById('gpsBtn').addEventListener('click', () => this.toggleGPS());
        document.getElementById('themeBtn').addEventListener('click', () => this.toggleTheme());
        document.getElementById('closeAIModalBtn').addEventListener('click', () => this.closeAIModal());
        document.getElementById('resetFiltersBtn').addEventListener('click', () => this.resetFilters());
        document.getElementById('exportCSVBtn').addEventListener('click', () => this.exportCSV());
        document.getElementById('routeModeBtn').addEventListener('click', () => this.toggleRouteMode());
        document.getElementById('optimizeRouteBtn').addEventListener('click', () => this.optimizeRoute());
        document.getElementById('clearRouteBtn').addEventListener('click', () => this.clearRoute());
        document.getElementById('generateProtocolBtn').addEventListener('click', () => this.generateAIProtocol());
        
        document.getElementById('searchInput').addEventListener('input', () => this.applyFilters());
        document.getElementById('okresFilter').addEventListener('change', () => this.applyFilters());
        document.getElementById('katFilter').addEventListener('change', () => this.applyFilters());
        
        document.querySelectorAll('.panel-head').forEach(head => {
            head.addEventListener('click', (e) => {
                const panelId = e.currentTarget.dataset.panel;
                this.togglePanel(panelId);
            });
        });
        
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                document.getElementById('searchInput').focus();
            }
            if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                this.resetFilters();
            }
            if (e.ctrlKey && e.key === 'e') {
                e.preventDefault();
                this.exportCSV();
            }
            if (e.ctrlKey && e.key === 'p') {
                e.preventDefault();
                this.generateAIProtocol();
            }
        });
    }

    registerServiceWorker() {
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(() => console.log('‚úÖ Service Worker registered'))
                .catch(() => console.log('‚ùå Service Worker registration failed'));
        }
    }
}

const app = new JVSApp();
</script>

</body>
</html>