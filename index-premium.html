<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>WaterMGMT PRO - JVS Premium</title>

    <!-- ‚úÖ FIX #1: Leaflet CSS & JS Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css">
    
    <!-- UI Resources -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --accent: #7c3aed;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg-glass: rgba(255, 255, 255, 0.95);
            --radius: 16px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; overflow: hidden; height: 100vh; background: #f1f5f9; }

        #map { position: absolute; top: 0; bottom: 0; width: 100%; z-index: 0; }

        /* Sidebar */
        .sidebar {
            position: fixed; top: 0; left: 0; bottom: 0; width: 400px; max-width: 90vw;
            background: var(--bg-glass); backdrop-filter: blur(12px);
            z-index: 1050; transform: translateX(-100%); transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 10px 0 30px rgba(0,0,0,0.1); border-right: 1px solid rgba(0,0,0,0.05);
        }
        .sidebar.active { transform: translateX(0); }

        /* Panels */
        .panel-section { background: white; border-radius: 12px; margin-bottom: 12px; border: 1px solid #e2e8f0; overflow: hidden; }
        .panel-head { 
            padding: 14px 18px; cursor: pointer; display: flex; justify-content: space-between; 
            align-items: center; font-weight: 600; transition: 0.2s;
        }
        .panel-head:hover { background: #f8fafc; }
        .panel-body { max-height: 0; transition: 0.3s ease-out; overflow: hidden; opacity: 0; }
        .panel-section.open .panel-body { max-height: 2000px; padding: 0 18px 18px; opacity: 1; }
        .panel-section.open .panel-head i.fa-chevron-down { transform: rotate(180deg); }

        /* FAB Buttons */
        .btn-fab {
            width: 56px; height: 56px; border-radius: 18px; display: flex; align-items: center;
            justify-content: center; font-size: 22px; box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            cursor: pointer; transition: 0.2s; border: none;
        }
        .btn-fab:active { transform: scale(0.9); }

        /* Custom Markers */
        .custom-marker {
            width: 30px; height: 30px; border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg); border: 3px solid white;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
        }
        .marker-critical { animation: pulse-red 2s infinite; }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        /* Quick Info Bar */
        .quick-info {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: white; padding: 10px 25px; border-radius: 40px;
            display: flex; gap: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            z-index: 900; border: 1px solid #e2e8f0;
        }

        /* Toast Notifications */
        .toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 10000; padding: 12px 24px; border-radius: 50px;
            background: #1e293b; color: white; display: flex; align-items: center; gap: 10px;
            box-shadow: 0 10px 15px rgba(0,0,0,0.2); animation: slideDown 0.3s;
        }
        @keyframes slideDown {
            from { transform: translate(-50%, -100px); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }

        /* Modal */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000;
            display: none; align-items: center; justify-content: center; padding: 20px;
        }
        .modal-overlay.active { display: flex; }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar { width: 100%; border-radius: 0; }
            .quick-info { width: 90vw; justify-content: space-around; font-size: 13px; }
        }
    </style>
</head>
<body>

    <div id="map"></div>

    <!-- UI Overlay -->
    <div class="fixed inset-0 pointer-events-none z-[1100]">
        <button class="pointer-events-auto absolute top-4 left-4 btn-fab bg-blue-600 text-white" id="toggleSidebarBtn">
            <i class="fas fa-bars"></i>
        </button>
        <button class="pointer-events-auto absolute top-4 right-4 btn-fab bg-emerald-500 text-white" id="addBtn">
            <i class="fas fa-plus"></i>
        </button>

        <div class="quick-info pointer-events-auto">
            <div><span class="text-blue-600 font-bold" id="qsCount">0</span> <span class="text-slate-400">Are√°l≈Ø</span></div>
            <div class="w-px h-6 bg-slate-200"></div>
            <div><span class="text-slate-700 font-bold" id="qsArea">0</span> <span class="text-slate-400">m¬≤</span></div>
            <div class="w-px h-6 bg-slate-200"></div>
            <div><span class="text-red-500 font-bold" id="qsCrit">0</span> <span class="text-slate-400">Rizik</span></div>
        </div>

        <!-- Layer Switcher -->
        <div class="absolute top-20 right-4 flex flex-col gap-2 pointer-events-auto">
            <button class="w-12 h-12 bg-white rounded-xl shadow-lg flex items-center justify-center text-slate-600" id="layerOSM">
                <i class="fas fa-map"></i>
            </button>
            <button class="w-12 h-12 bg-white rounded-xl shadow-lg flex items-center justify-center text-slate-600" id="layerSAT">
                <i class="fas fa-satellite"></i>
            </button>
        </div>
    </div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="p-6 bg-blue-600 text-white flex justify-between items-center">
            <div>
                <h1 class="text-xl font-extrabold flex items-center gap-2">
                    <i class="fas fa-droplet"></i> WaterMGMT <span class="font-light opacity-80">PRO</span>
                </h1>
                <p class="text-xs opacity-70">JVS - Jihoƒçesk√Ω vod√°rensk√Ω svaz</p>
            </div>
            <button id="closeSidebarBtn" class="text-2xl">&times;</button>
        </div>

        <div class="p-4 overflow-y-auto h-[calc(100vh-100px)]">
            <!-- Search & Filters -->
            <div class="panel-section open">
                <div class="panel-head">
                    <span><i class="fas fa-search mr-2"></i> Filtrov√°n√≠</span>
                    <i class="fas fa-chevron-down transition-transform"></i>
                </div>
                <div class="panel-body">
                    <input type="text" id="search" placeholder="N√°zev objektu..." class="w-full p-3 bg-slate-100 rounded-lg mb-3">
                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <select id="fOkres" class="p-3 bg-slate-100 rounded-lg">
                            <option value="all">V≈°echny okresy</option>
                            <option value="CB">ƒå. Budƒõjovice</option>
                            <option value="TA">T√°bor</option>
                            <option value="CK">ƒå. Krumlov</option>
                            <option value="PT">Prachatice</option>
                            <option value="PI">P√≠sek</option>
                            <option value="ST">Strakonice</option>
                        </select>
                        <select id="fKat" class="p-3 bg-slate-100 rounded-lg">
                            <option value="all">V≈°echny kat.</option>
                            <option value="1.">Kat. I (Vysok√°)</option>
                            <option value="II.">Kat. II (St≈ôedn√≠)</option>
                        </select>
                    </div>
                    <label class="flex items-center gap-3 p-2 bg-slate-50 rounded-lg cursor-pointer">
                        <input type="checkbox" id="tHeat" class="w-5 h-5 accent-blue-600">
                        <span class="text-sm font-medium">Zobrazit heatmapu rizik</span>
                    </label>
                </div>
            </div>

            <!-- Route Planner -->
            <div class="panel-section">
                <div class="panel-head">
                    <span><i class="fas fa-route mr-2 text-purple-600"></i> Pl√°novaƒç v√Ωjezd≈Ø</span>
                    <i class="fas fa-chevron-down transition-transform"></i>
                </div>
                <div class="panel-body">
                    <div class="p-3 bg-purple-50 rounded-xl border border-purple-100 mb-3">
                        <div class="flex justify-between text-xs font-bold text-purple-700 uppercase mb-2">
                            <span>Zvolen√° trasa</span>
                            <span id="routeMeta">0 km | 0 min</span>
                        </div>
                        <div id="routeList" class="flex flex-wrap gap-2 text-xs">
                            <span class="text-slate-400 italic">Kliknƒõte na are√°ly v mapƒõ...</span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button class="flex-1 p-3 bg-purple-600 text-white rounded-xl font-bold text-sm" id="optimizeBtn">
                            <i class="fas fa-magic mr-1"></i> Optimalizovat
                        </button>
                        <button class="p-3 bg-slate-200 text-slate-600 rounded-xl" id="clearRouteBtn">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <button class="w-full mt-2 p-3 bg-blue-600 text-white rounded-xl font-bold text-sm" id="generatePDFBtn">
                        <i class="fas fa-robot mr-1"></i> Generovat AI Protokol (PDF)
                    </button>
                </div>
            </div>

            <!-- Stats -->
            <div class="panel-section">
                <div class="panel-head">
                    <span><i class="fas fa-chart-pie mr-2 text-emerald-600"></i> Statistiky</span>
                    <i class="fas fa-chevron-down transition-transform"></i>
                </div>
                <div class="panel-body">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="p-4 bg-slate-50 rounded-xl border border-slate-100">
                            <span class="block text-2xl font-black text-blue-600" id="sCount">0</span>
                            <span class="text-[10px] text-slate-500 uppercase font-bold">Poƒçet are√°l≈Ø</span>
                        </div>
                        <div class="p-4 bg-slate-50 rounded-xl border border-slate-100">
                            <span class="block text-2xl font-black text-emerald-600" id="sDone">0</span>
                            <span class="text-[10px] text-slate-500 uppercase font-bold">Hotovo (7d)</span>
                        </div>
                    </div>
                    <button class="w-full mt-3 p-3 bg-slate-800 text-white rounded-xl font-bold text-sm" id="exportCSVBtn">
                        <i class="fas fa-file-csv mr-1"></i> Exportovat CSV
                    </button>
                </div>
            </div>
        </div>
    </aside>

    <!-- Modal: Areal Editor -->
    <div id="modal" class="modal-overlay">
        <div class="bg-white rounded-2xl w-full max-w-md overflow-hidden shadow-2xl">
            <div class="p-6 bg-slate-50 border-b flex justify-between items-center">
                <h2 class="text-xl font-extrabold" id="mTitle">Editace are√°lu</h2>
                <button id="closeModalBtn" class="text-2xl">&times;</button>
            </div>
            <form id="arealForm" class="p-6 space-y-4">
                <input type="hidden" id="aId">
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase">N√°zev objektu</label>
                    <input type="text" id="aName" required class="w-full p-3 bg-slate-100 rounded-lg">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Okres</label>
                        <select id="aOkres" class="w-full p-3 bg-slate-100 rounded-lg">
                            <option value="CB">CB</option><option value="TA">TA</option><option value="CK">CK</option>
                            <option value="PT">PT</option><option value="PI">PI</option><option value="ST">ST</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Kategorie</label>
                        <select id="aKat" class="w-full p-3 bg-slate-100 rounded-lg">
                            <option value="">Bez kat.</option>
                            <option value="1.">I. Vysok√°</option>
                            <option value="II.">II. St≈ôedn√≠</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase">V√Ωmƒõra (m¬≤)</label>
                        <input type="number" id="aArea" required class="w-full p-3 bg-slate-100 rounded-lg">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Plot (bm)</label>
                        <input type="number" id="aFence" required class="w-full p-3 bg-slate-100 rounded-lg">
                    </div>
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="button" class="flex-1 p-4 bg-slate-100 rounded-xl font-bold" id="cancelFormBtn">Zru≈°it</button>
                    <button type="submit" class="flex-1 p-4 bg-blue-600 text-white rounded-xl font-bold">Ulo≈æit data</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ‚úÖ FIX #1: Load Scripts in Correct Order -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-heat/0.2.0/leaflet-heat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script type="module">
        // ‚úÖ FIX #3: Load Real Data (41 Areals)
        const arealData = [
            { id: 1, nazev: "VDJ Amerika II", okres: "PI", kategorie: "1.", oploceni: 293, vymera: 3303, lat: 49.3051, lon: 14.1661 },
            { id: 2, nazev: "VDJ Drahonice", okres: "ST", kategorie: "1.", oploceni: 376, vymera: 5953, lat: 49.2029, lon: 14.0637 },
            { id: 3, nazev: "VDJ Vod≈àany", okres: "ST", kategorie: "1.", oploceni: 252, vymera: 1594, lat: 49.1477, lon: 14.1752 },
            { id: 4, nazev: "VDJ Hlavatce", okres: "CB", kategorie: "", oploceni: 424, vymera: 7968, lat: 49.0635, lon: 14.2677 },
            { id: 5, nazev: "VDJ ≈†ibeniƒçn√≠ vrch I", okres: "PT", kategorie: "1.", oploceni: 245, vymera: 1835, lat: 49.0133, lon: 13.9944 },
            { id: 6, nazev: "√öV Husinecka p≈ôehrada", okres: "PT", kategorie: "", oploceni: 703, vymera: 4908, lat: 49.0588, lon: 13.9947 },
            { id: 7, nazev: "VDJ ≈†ibeniƒçn√≠ vrch II", okres: "PT", kategorie: "1.", oploceni: 340, vymera: 3206, lat: 49.0267, lon: 13.9940 },
            { id: 8, nazev: "VDJ Z√°lu≈æany", okres: "PI", kategorie: "", oploceni: 299, vymera: 2350, lat: 49.3163, lon: 14.0961 },
            { id: 9, nazev: "VDJ Pt√°ƒçn√≠k", okres: "PT", kategorie: "II.", oploceni: 239, vymera: 1070, lat: 49.0911, lon: 13.9480 },
            { id: 10, nazev: "VDJ Zdoba", okres: "CB", kategorie: "II.", oploceni: 225, vymera: 15523, lat: 49.2124, lon: 14.3380 },
            { id: 11, nazev: "VDJ Domoradice", okres: "CK", kategorie: "1.", oploceni: 450, vymera: 4148, lat: 48.8127, lon: 14.2730 },
            { id: 12, nazev: "VDJ Horn√≠ Br√°na", okres: "CK", kategorie: "1.", oploceni: 187, vymera: 1665, lat: 48.8079, lon: 14.3293 },
            { id: 13, nazev: "VDJ Net≈ôebice", okres: "CK", kategorie: "1.", oploceni: 136, vymera: 877, lat: 48.8563, lon: 14.3186 },
            { id: 14, nazev: "VDJ Ple≈°ivec", okres: "CK", kategorie: "1.", oploceni: 119, vymera: 975, lat: 48.8230, lon: 14.1652 },
            { id: 15, nazev: "VDJ Doudleby", okres: "CB", kategorie: "II.", oploceni: 79, vymera: 413, lat: 48.9919, lon: 14.5055 },
            { id: 16, nazev: "VDJ Jankov", okres: "CB", kategorie: "1.", oploceni: 106, vymera: 784, lat: 49.0335, lon: 14.4928 },
            { id: 17, nazev: "VDJ Hos√≠n II", okres: "CB", kategorie: "1.", oploceni: 399, vymera: 4173, lat: 49.0161, lon: 14.4527 },
            { id: 18, nazev: "VDJ Chlum", okres: "CB", kategorie: "II.", oploceni: 63, vymera: 535, lat: 49.0919, lon: 14.5341 },
            { id: 19, nazev: "VDJ Chot√Ωƒçany", okres: "CB", kategorie: "II.", oploceni: 338, vymera: 4775, lat: 49.1336, lon: 14.4988 },
            { id: 20, nazev: "VDJ Rudolfov III", okres: "CB", kategorie: "1.", oploceni: 174, vymera: 1868, lat: 48.9888, lon: 14.5958 },
            { id: 21, nazev: "VDJ Rimov - Vesce", okres: "CB", kategorie: "1.", oploceni: 99, vymera: 662, lat: 48.8427, lon: 14.5250 },
            { id: 22, nazev: "VDJ Hosin", okres: "CB", kategorie: "II.", oploceni: 125, vymera: 809, lat: 49.0138, lon: 14.4502 },
            { id: 23, nazev: "VDJ Vƒçeln√°", okres: "CB", kategorie: "II.", oploceni: 476, vymera: 8660, lat: 48.9663, lon: 14.4547 },
            { id: 24, nazev: "VDJ H√∫ry", okres: "CB", kategorie: "1.", oploceni: 0, vymera: 395, lat: 49.0586, lon: 14.4819 },
            { id: 25, nazev: "VDJ Chlumec", okres: "CB", kategorie: "II.", oploceni: 110, vymera: 811, lat: 49.0541, lon: 14.4888 },
            { id: 26, nazev: "VDJ Ole≈°n√≠k", okres: "CB", kategorie: "1.", oploceni: 117, vymera: 380, lat: 49.0569, lon: 14.4986 },
            { id: 27, nazev: "ƒåS Bukovec", okres: "CB", kategorie: "1.", oploceni: 300, vymera: 4943, lat: 48.9491, lon: 14.4808 },
            { id: 28, nazev: "VDJ He≈ôman", okres: "CB", kategorie: "II.", oploceni: 119, vymera: 982, lat: 48.9916, lon: 14.5350 },
            { id: 29, nazev: "ƒåS Vidov u ≈ôeky", okres: "CB", kategorie: "II.", oploceni: 212, vymera: 2501, lat: 48.9508, lon: 14.4797 },
            { id: 30, nazev: "Vrt Vidov", okres: "CB", kategorie: "II.", oploceni: 164, vymera: 470, lat: 48.9511, lon: 14.4805 },
            { id: 31, nazev: "√öV Plav", okres: "CB", kategorie: "1.", oploceni: 1413, vymera: 74777, lat: 49.0061, lon: 14.4527 },
            { id: 32, nazev: "VDJ ƒåekanice", okres: "TA", kategorie: "1.", oploceni: 450, vymera: 6344, lat: 49.4221, lon: 14.6898 },
            { id: 33, nazev: "VDJ Svat√° Anna", okres: "TA", kategorie: "1.", oploceni: 264, vymera: 4192, lat: 49.4011, lon: 14.6986 },
            { id: 34, nazev: "VDJ Bezdƒõƒç√≠n", okres: "TA", kategorie: "1.", oploceni: 169, vymera: 1996, lat: 49.3816, lon: 14.7005 },
            { id: 35, nazev: "VDJ Milevsko", okres: "TA", kategorie: "1.", oploceni: 129, vymera: 823, lat: 49.4525, lon: 14.3441 },
            { id: 36, nazev: "VDJ Hodu≈°√≠n", okres: "TA", kategorie: "II.", oploceni: 205, vymera: 1708, lat: 49.4296, lon: 14.4742 },
            { id: 37, nazev: "VDJ V≈°echov", okres: "TA", kategorie: "1.", oploceni: 199, vymera: 1574, lat: 49.4301, lon: 14.6232 },
            { id: 38, nazev: "VDJ Zlukov", okres: "TA", kategorie: "II.", oploceni: 184, vymera: 1520, lat: 49.1962, lon: 14.7363 },
            { id: 39, nazev: "√öV T√°bor", okres: "TA", kategorie: "II.", oploceni: 350, vymera: 12262, lat: 49.4228, lon: 14.6664 },
            { id: 40, nazev: "ƒåS Sudomƒõ≈ôice", okres: "TA", kategorie: "1.", oploceni: 220, vymera: 2508, lat: 49.3686, lon: 14.7202 },
            { id: 41, nazev: "Provozn√≠ Vodojem T√°bor", okres: "TA", kategorie: "II.", oploceni: 155, vymera: 1853, lat: 49.4138, lon: 14.6591 }
        ];

        // App State
        let map, clusters, heatLayer, markers = [];
        let selectedRoute = [];
        let addMode = false;
        let activeLayers = { osm: null, sat: null };

        const CONFIG = {
            center: [49.15, 14.35],
            zoom: 10,
            storageKey: 'jvs_pro_v4',
            avgSpeed: 45
        };

        // ‚úÖ FIX #2: Initialize on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            initMap();
            initEventListeners();
            renderAll();
            showToast("üöÄ WaterMGMT PRO P≈ôipraven");
        });

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView(CONFIG.center, CONFIG.zoom);
            
            activeLayers.osm = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '¬© OpenStreetMap'
            }).addTo(map);
            
            activeLayers.sat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '¬© Esri'
            });

            clusters = L.markerClusterGroup({
                maxClusterRadius: 50,
                iconCreateFunction: (c) => L.divIcon({
                    html: `<div class="bg-blue-600 text-white rounded-full w-10 h-10 flex items-center justify-center font-bold border-2 border-white shadow-lg">${c.getChildCount()}</div>`,
                    className: '', iconSize: [40, 40]
                })
            });
            map.addLayer(clusters);
        }

        // ‚úÖ FIX #2: Event Listeners
        function initEventListeners() {
            // Sidebar
            document.getElementById('toggleSidebarBtn').addEventListener('click', toggleSidebar);
            document.getElementById('closeSidebarBtn').addEventListener('click', toggleSidebar);

            // Filters
            document.getElementById('search').addEventListener('input', applyFilters);
            document.getElementById('fOkres').addEventListener('change', applyFilters);
            document.getElementById('fKat').addEventListener('change', applyFilters);
            document.getElementById('tHeat').addEventListener('change', toggleHeatmap);

            // Route
            document.getElementById('optimizeBtn').addEventListener('click', optimizeRoute);
            document.getElementById('clearRouteBtn').addEventListener('click', clearRoute);
            document.getElementById('generatePDFBtn').addEventListener('click', generateAIReport);

            // Export
            document.getElementById('exportCSVBtn').addEventListener('click', exportData);

            // Layers
            document.getElementById('layerOSM').addEventListener('click', () => switchLayer('osm'));
            document.getElementById('layerSAT').addEventListener('click', () => switchLayer('sat'));

            // Modal
            document.getElementById('closeModalBtn').addEventListener('click', closeModal);
            document.getElementById('cancelFormBtn').addEventListener('click', closeModal);
            document.getElementById('arealForm').addEventListener('submit', handleFormSubmit);

            // Panel Accordions
            document.querySelectorAll('.panel-head').forEach(head => {
                head.addEventListener('click', () => {
                    head.parentElement.classList.toggle('open');
                });
            });
        }

        function renderAll() {
            clusters.clearLayers();
            markers = [];

            const search = document.getElementById('search').value.toLowerCase();
            const okres = document.getElementById('fOkres').value;
            const kat = document.getElementById('fKat').value;

            const filtered = arealData.filter(a => {
                const mS = a.nazev.toLowerCase().includes(search);
                const mO = okres === 'all' || a.okres === okres;
                const mK = kat === 'all' || a.kategorie === kat;
                return mS && mO && mK;
            });

            filtered.forEach(a => {
                const color = a.kategorie === '1.' ? '#ef4444' : (a.kategorie === 'II.' ? '#f59e0b' : '#64748b');
                const isCrit = a.kategorie === '1.' && !a.lastUdrzba;

                const icon = L.divIcon({
                    html: `<div class="custom-marker ${isCrit ? 'marker-critical' : ''}" style="background:${color}"></div>`,
                    className: '', iconSize: [30, 30], iconAnchor: [15, 30]
                });

                const m = L.marker([a.lat, a.lon], { icon });
                m.on('click', () => handleMarkerClick(a));
                clusters.addLayer(m);
                markers.push({ id: a.id, marker: m });
            });

            updateStats(filtered);
        }

        async function handleMarkerClick(a) {
            const sidebar = document.getElementById('sidebar');
            if(sidebar.classList.contains('active')) {
                addToRoute(a);
                return;
            }

            const weather = await fetchWeather(a.lat, a.lon);
            const date = a.lastUdrzba ? new Date(a.lastUdrzba).toLocaleDateString('cs-CZ') : 'Nebyla';

            const popup = L.popup()
                .setLatLng([a.lat, a.lon])
                .setContent(`
                    <div class="p-2 min-w-[200px]">
                        <h3 class="font-bold border-b pb-1 mb-2">${a.nazev}</h3>
                        <div class="text-xs space-y-1 mb-3">
                            <p><b>Okres:</b> ${a.okres} | <b>Kat:</b> ${a.kategorie || 'N/A'}</p>
                            <p><b>Plocha:</b> ${a.vymera} m¬≤ | <b>Plot:</b> ${a.oploceni} bm</p>
                            <p><b>Posledn√≠:</b> ${date}</p>
                        </div>
                        <div class="bg-blue-50 p-2 rounded text-[10px] mb-3 flex justify-between">
                            <span>üå°Ô∏è ${weather.temp}¬∞C</span>
                            <span>üí® ${weather.wind} km/h</span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="window.markDone(${a.id})" class="flex-1 bg-emerald-500 text-white p-2 rounded text-[10px] font-bold">HOTOVO</button>
                            <button onclick="window.editAreal(${a.id})" class="flex-1 bg-slate-100 p-2 rounded text-[10px] font-bold">UPRAVIT</button>
                        </div>
                    </div>
                `)
                .openOn(map);
        }

        function addToRoute(a) {
            if(selectedRoute.find(r => r.id === a.id)) return;
            selectedRoute.push(a);
            updateRouteUI();
            showToast(`P≈ôid√°no: ${a.nazev}`);
        }

        function updateRouteUI() {
            const list = document.getElementById('routeList');
            if(selectedRoute.length === 0) {
                list.innerHTML = `<span class="text-slate-400 italic">Kliknƒõte na are√°ly v mapƒõ...</span>`;
                document.getElementById('routeMeta').textContent = '0 km | 0 min';
                return;
            }

            list.innerHTML = selectedRoute.map((a, i) => `
                <div class="bg-white px-2 py-1 rounded-full border border-purple-200 flex items-center gap-2">
                    <span class="font-black text-purple-600">${i+1}</span>
                    <span class="text-xs">${a.nazev}</span>
                    <i class="fas fa-times opacity-30 cursor-pointer" onclick="window.removeFromRoute(${a.id})"></i>
                </div>
            `).join('');

            let d = 0;
            for(let i=0; i<selectedRoute.length-1; i++) {
                const p1 = L.latLng(selectedRoute[i].lat, selectedRoute[i].lon);
                const p2 = L.latLng(selectedRoute[i+1].lat, selectedRoute[i+1].lon);
                d += p1.distanceTo(p2);
            }
            const km = (d/1000) * 1.3;
            const t = Math.round(km / CONFIG.avgSpeed * 60);
            document.getElementById('routeMeta').textContent = `${km.toFixed(1)} km | ~${t} min`;
        }

        function optimizeRoute() {
            if(selectedRoute.length < 3) return showToast("Vyberte aspo≈à 3 body", "warning");
            
            let unvisited = [...selectedRoute];
            let optimized = [unvisited.shift()];
            
            while(unvisited.length > 0) {
                let last = optimized[optimized.length-1];
                let bestIdx = 0;
                let bestDist = Infinity;
                
                unvisited.forEach((curr, idx) => {
                    let d = L.latLng(last.lat, last.lon).distanceTo(L.latLng(curr.lat, curr.lon));
                    if(d < bestDist) { bestDist = d; bestIdx = idx; }
                });
                optimized.push(unvisited.splice(bestIdx, 1)[0]);
            }
            selectedRoute = optimized;
            updateRouteUI();
            showToast("‚úÖ Trasa optimalizov√°na", "success");
        }

        function clearRoute() {
            selectedRoute = [];
            updateRouteUI();
            showToast("Trasa vymaz√°na");
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }

        function switchLayer(l) {
            if(l === 'osm') {
                map.removeLayer(activeLayers.sat);
                map.addLayer(activeLayers.osm);
            } else {
                map.removeLayer(activeLayers.osm);
                map.addLayer(activeLayers.sat);
            }
        }

        function toggleHeatmap() {
            const active = document.getElementById('tHeat').checked;
            if(heatLayer) map.removeLayer(heatLayer);
            if(active) {
                const points = arealData.map(a => [a.lat, a.lon, a.kategorie === '1.' ? 1 : 0.5]);
                heatLayer = L.heatLayer(points, {radius: 40, blur: 25}).addTo(map);
            }
        }

        function showToast(m, type = 'info') {
            const t = document.createElement('div');
            t.className = 'toast';
            t.innerHTML = `<i class="fas fa-info-circle"></i> ${m}`;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        function loadData() {
            const saved = localStorage.getItem(CONFIG.storageKey);
            if(saved) {
                const parsed = JSON.parse(saved);
                arealData.forEach((a, i) => {
                    const s = parsed.find(x => x.id === a.id);
                    if(s) arealData[i] = {...a, ...s};
                });
            }
        }

        function saveData() {
            localStorage.setItem(CONFIG.storageKey, JSON.stringify(arealData));
        }

        function updateStats(data) {
            const count = data.length;
            const area = data.reduce((s, a) => s + a.vymera, 0);
            const crit = data.filter(a => a.kategorie === '1.').length;
            const done = data.filter(a => a.lastUdrzba && (Date.now() - a.lastUdrzba < 7*86400000)).length;

            document.getElementById('qsCount').textContent = count;
            document.getElementById('sCount').textContent = count;
            document.getElementById('qsArea').textContent = (area/1000).toFixed(1) + 'k';
            document.getElementById('qsCrit').textContent = crit;
            document.getElementById('sDone').textContent = done;
        }

        async function fetchWeather(lat, lon) {
            try {
                const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,wind_speed_10m`);
                const d = await r.json();
                return { temp: Math.round(d.current.temperature_2m), wind: Math.round(d.current.wind_speed_10m) };
            } catch { return { temp: '?', wind: '?' }; }
        }

        function editAreal(id) {
            const a = arealData.find(x => x.id === id);
            document.getElementById('aId').value = a.id;
            document.getElementById('aName').value = a.nazev;
            document.getElementById('aOkres').value = a.okres;
            document.getElementById('aKat').value = a.kategorie;
            document.getElementById('aArea').value = a.vymera;
            document.getElementById('aFence').value = a.oploceni;
            document.getElementById('modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        function handleFormSubmit(e) {
            e.preventDefault();
            const id = parseInt(document.getElementById('aId').value);
            const idx = arealData.findIndex(x => x.id === id);
            
            arealData[idx] = {
                ...arealData[idx],
                nazev: document.getElementById('aName').value,
                okres: document.getElementById('aOkres').value,
                kategorie: document.getElementById('aKat').value,
                vymera: parseInt(document.getElementById('aArea').value),
                oploceni: parseInt(document.getElementById('aFence').value)
            };

            saveData();
            renderAll();
            closeModal();
            showToast("‚úÖ Zmƒõny ulo≈æeny");
        }

        function markDone(id) {
            const idx = arealData.findIndex(x => x.id === id);
            arealData[idx].lastUdrzba = Date.now();
            saveData();
            renderAll();
            map.closePopup();
            showToast("‚úÖ √ödr≈æba zaznamen√°na", "success");
        }

        function generateAIReport() {
            if(selectedRoute.length === 0) return showToast("Pr√°zdn√° trasa", "warning");
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(20);
            doc.text("PROTOKOL √öDR≈ΩBY JVS", 105, 20, { align: 'center' });
            doc.setFontSize(10);
            doc.text(`Datum v√Ωjezdu: ${new Date().toLocaleDateString('cs-CZ')}`, 105, 28, { align: 'center' });
            
            let y = 45;
            selectedRoute.forEach((a, i) => {
                doc.setFont(undefined, 'bold');
                doc.text(`${i+1}. ${a.nazev} (${a.okres})`, 20, y);
                doc.setFont(undefined, 'normal');
                doc.text(`Plocha: ${a.vymera} m2 | Plot: ${a.oploceni} bm | Kat: ${a.kategorie || 'N/A'}`, 25, y + 5);
                doc.text(`√ökoly: Seƒçen√≠, kontrola z√°mk≈Ø, revize oplocen√≠.`, 25, y + 10);
                doc.rect(170, y - 2, 10, 10);
                y += 25;
                if(y > 270) { doc.addPage(); y = 20; }
            });

            doc.save(`Protokol-JVS-${Date.now()}.pdf`);
            showToast("‚úÖ PDF report vygenerov√°n");
        }

        function exportData() {
            const csv = [
                ['N√°zev', 'Okres', 'Kategorie', 'V√Ωmƒõra (m¬≤)', 'Oplocen√≠ (bm)', 'Latitude', 'Longitude'],
                ...arealData.map(a => [a.nazev, a.okres, a.kategorie || 'N/A', a.vymera, a.oploceni, a.lat, a.lon])
            ].map(row => row.join(',')).join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `JVS-Export-${Date.now()}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            showToast("‚úÖ CSV exportov√°n");
        }

        function applyFilters() {
            renderAll();
        }

        function removeFromRoute(id) {
            selectedRoute = selectedRoute.filter(r => r.id !== id);
            updateRouteUI();
        }

        // Global functions for popup buttons
        window.editAreal = editAreal;
        window.markDone = markDone;
        window.removeFromRoute = removeFromRoute;
    </script>
</body>
</html>
