<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>JVS Provozn√≠ mapa</title>

    <!-- Leaflet & Extensions -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#1f2937',
                        success: '#10b981',
                        danger: '#ef4444',
                        warning: '#f59e0b',
                        background: '#0f172a'
                    }
                }
            }
        }
    </script>

    <style>
        html, body { 
            margin: 0; 
            padding: 0; 
            height: 100%; 
            overflow: hidden; 
            background: #0f172a; 
            color: #e5e7eb; 
            font-family: 'Inter', system-ui; 
        }
        
        #mapWrapper { 
            height: 100dvh; 
            width: 100%; 
            position: relative; 
        }
        
        @supports (-webkit-touch-callout: none) {
            body, #mapWrapper { height: -webkit-fill-available; }
        }
        
        .panel { 
            transition: transform .3s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 90vh;
        }
        
        #map { height: 100%; width: 100%; }
        
        .leaflet-popup-content-wrapper { 
            background: #1f2937; 
            color: #e5e7eb; 
            border-radius: 0.75rem; 
        }
        
        .leaflet-popup-tip { background: #1f2937; }
        
        .leaflet-draw-section a { color: #3b82f6 !important; }

        .toast {
            animation: fadeInOut 4s ease-in-out forwards;
            pointer-events: none;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }

        .spinner { 
            border: 4px solid rgba(255,255,255,.1); 
            border-left-color: #3b82f6; 
            border-radius: 50%; 
            width: 32px; 
            height: 32px; 
            animation: spin 1s linear infinite; 
            margin: 20px auto; 
        }
        
        @keyframes spin { 
            0% { transform: rotate(0) } 
            100% { transform: rotate(360deg) } 
        }
    </style>
</head>

<body class="bg-background text-white">

<!-- Header -->
<header class="fixed top-0 left-0 right-0 z-[1000] bg-background/90 backdrop-blur flex items-center justify-between p-4 shadow-xl">
    <div class="flex items-center gap-2">
        <i class="fas fa-water text-primary text-2xl"></i>
        <h1 class="text-xl font-bold">JVS Provoz</h1>
        <span id="userIdDisplay" class="text-xs opacity-50 ml-2">ID: OFFLINE</span>
    </div>
    <div class="flex gap-2">
        <button id="locateBtn" class="bg-primary/20 text-primary p-3 rounded-full text-lg shadow-lg hover:bg-primary/30 transition-colors">
            <i class="fas fa-location-crosshairs"></i>
        </button>
        <button id="togglePanelBtn" class="bg-primary/20 text-primary p-3 rounded-full text-lg shadow-lg hover:bg-primary/30 transition-colors">
            <i class="fas fa-sliders-h"></i>
        </button>
    </div>
</header>

<!-- Map Container -->
<div id="mapWrapper">
    <div id="map"></div>
</div>

<!-- Toast Notifications Container -->
<div id="toastContainer" class="fixed top-20 right-4 z-[1001] space-y-2"></div>

<!-- Modal Container -->
<div id="modal" class="fixed inset-0 bg-black/70 z-[1002] flex items-center justify-center p-4 hidden">
    <div id="modalContent" class="bg-slate-800 rounded-xl p-6 w-full max-w-md shadow-2xl space-y-4">
        <h2 id="modalTitle" class="text-xl font-bold text-primary"></h2>
        <form id="areaForm" class="space-y-3">
            <input type="hidden" id="areaIndex">
            <input type="hidden" id="areaLat">
            <input type="hidden" id="areaLng">
            
            <label class="block">
                N√°zev:
                <input type="text" id="areaName" required class="w-full p-3 rounded bg-slate-700 border border-slate-600 focus:ring-primary focus:border-primary">
            </label>
            
            <label class="block">
                Okres:
                <input type="text" id="areaDistrict" required class="w-full p-3 rounded bg-slate-700 border border-slate-600">
            </label>
            
            <label class="block">
                Kategorie (I./II./pr√°zdn√©):
                <input type="text" id="areaCategory" class="w-full p-3 rounded bg-slate-700 border border-slate-600">
            </label>
            
            <label class="block">
                Plocha (m¬≤):
                <input type="number" id="areaArea" required class="w-full p-3 rounded bg-slate-700 border border-slate-600">
            </label>
            
            <label class="block">
                Oplocen√≠ (bm):
                <input type="number" id="areaFence" required class="w-full p-3 rounded bg-slate-700 border border-slate-600">
            </label>

            <button type="submit" class="w-full bg-success py-3 rounded-lg text-lg font-semibold hover:bg-success/90 transition-colors">
                Ulo≈æit zmƒõny
            </button>
            <button type="button" id="cancelModalBtn" class="w-full bg-slate-600 py-3 rounded-lg text-lg font-semibold mt-2 hover:bg-slate-500 transition-colors">
                Zru≈°it
            </button>
        </form>
    </div>
</div>

<!-- Bottom Sheet Panel -->
<div class="fixed bottom-0 left-0 right-0 z-[1000] bg-secondary/95 backdrop-blur rounded-t-3xl shadow-2xl panel" id="panel" style="transform:translateY(calc(100% - 70px))">
    <div class="h-[70px] flex items-center justify-center cursor-pointer" id="panelHandle">
        <i class="fas fa-chevron-up text-3xl text-primary/70 transition-transform duration-300" id="panelHandleIcon"></i>
    </div>
    
    <div class="p-4 space-y-6 overflow-y-auto" id="panelContent">
        
        <div class="section bg-slate-800 p-4 rounded-xl shadow-inner">
            <h2 class="text-lg font-bold mb-3 text-primary">üìä Souhrn & Filtry</h2>
            
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="bg-slate-700 p-3 rounded-lg text-center">
                    <div class="text-xl font-bold" id="totalArea">0</div>
                    <div class="text-xs opacity-70">Celkov√° plocha (m¬≤)</div>
                </div>
                <div class="bg-slate-700 p-3 rounded-lg text-center">
                    <div class="text-xl font-bold text-danger" id="remainingArea">0</div>
                    <div class="text-xs opacity-70">Zb√Ωv√° sekat (m¬≤)</div>
                </div>
                <div class="bg-slate-700 p-3 rounded-lg text-center">
                    <div class="text-xl font-bold" id="totalFence">0</div>
                    <div class="text-xs opacity-70">Oplocen√≠ (bm)</div>
                </div>
                <div class="bg-slate-700 p-3 rounded-lg text-center">
                    <div class="text-xl font-bold" id="objectCount">0</div>
                    <div class="text-xs opacity-70">Are√°l≈Ø (filtr)</div>
                </div>
            </div>

            <input id="searchInput" type="text" placeholder="Hledat n√°zev are√°lu..." class="w-full p-3 rounded bg-slate-700 border border-slate-600 mt-2">
            <select id="districtFilter" class="w-full p-3 rounded bg-slate-700 border border-slate-600 mt-2">
                <option value="">V≈°echny okresy</option>
            </select>
            
            <div class="mt-2 flex gap-2">
                <label for="heatmapToggle" class="flex-grow flex items-center justify-between bg-slate-700 p-3 rounded-lg cursor-pointer">
                    <span>Heatmapa rizika</span>
                    <input type="checkbox" id="heatmapToggle" class="w-5 h-5 text-primary bg-slate-600 border-slate-500 rounded focus:ring-primary">
                </label>
                <label for="maintainedToggle" class="flex-grow flex items-center justify-between bg-slate-700 p-3 rounded-lg cursor-pointer">
                    <span>Jen k √∫dr≈æbƒõ</span>
                    <input type="checkbox" id="maintainedToggle" class="w-5 h-5 text-primary bg-slate-600 border-slate-500 rounded focus:ring-primary">
                </label>
            </div>
        </div>

        <div class="section bg-slate-800 p-4 rounded-xl shadow-inner">
            <h2 class="text-lg font-bold mb-3 text-primary">üó∫Ô∏è Trasa a Navigace</h2>
            <div id="routeStatus" class="text-sm opacity-80 mb-3">Trasa nen√≠ aktivn√≠. P≈ôidejte alespo≈à 2 are√°ly.</div>
            <div id="routeList" class="space-y-2 mb-4"></div>
            <button id="resetRouteBtn" class="w-full bg-warning py-3 rounded-lg mb-2">
                <i class="fas fa-route"></i> Reset trasy
            </button>
            <button id="generateAIReportBtn" class="w-full bg-purple-600 py-3 rounded-lg">
                <i class="fas fa-robot"></i> Generovat AI Protokol
            </button>
        </div>

        <div class="section bg-slate-800 p-4 rounded-xl shadow-inner">
            <h2 class="text-lg font-bold mb-3 text-primary">‚òÅÔ∏è Poƒças√≠ v centru mapy</h2>
            <div id="weatherContent" class="text-center py-4 text-sm">
                <div class="spinner"></div>
            </div>
        </div>

        <div class="section">
             <button id="addNewAreaBtn" class="w-full bg-success py-3 rounded-lg text-lg font-semibold">
                <i class="fas fa-plus"></i> P≈ôidat nov√Ω are√°l
             </button>
        </div>
        
        <div class="section text-center p-4">
             <button id="resetAllDataBtn" class="text-sm text-danger/70 hover:text-danger">
                Glob√°ln√≠ Reset Dat (vyma≈æe lok√°ln√≠ data i trasu)
             </button>
        </div>
        
    </div>
</div>

<!-- Scripts -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<!-- Firebase -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, setLogLevel, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    window.db = null;
    window.auth = null;
    window.userId = null;
    window.serverTimestamp = serverTimestamp;
    window.doc = doc;
    window.updateDoc = updateDoc;
    window.deleteDoc = deleteDoc;
    window.setDoc = setDoc;
    window.addDoc = addDoc;
    window.collection = collection;
    window.onSnapshot = onSnapshot;

    setLogLevel('error');

    if (Object.keys(firebaseConfig).length > 0) {
        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        window.auth = getAuth(app);

        onAuthStateChanged(window.auth, async (user) => {
            if (user) {
                window.userId = user.uid;
                const userIdEl = document.getElementById('userIdDisplay');
                if (userIdEl) {
                    userIdEl.textContent = `ID: ${user.uid.substring(0, 8)}...`;
                }
            } else {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(window.auth, initialAuthToken);
                        window.userId = window.auth.currentUser.uid;
                        const userIdEl = document.getElementById('userIdDisplay');
                        if (userIdEl) {
                            userIdEl.textContent = `ID: ${window.userId.substring(0, 8)}...`;
                        }
                    } else {
                        await signInAnonymously(window.auth);
                        window.userId = window.auth.currentUser.uid;
                        const userIdEl = document.getElementById('userIdDisplay');
                        if (userIdEl) {
                            userIdEl.textContent = `ID: ${window.userId.substring(0, 8)} (anonym)`;
                        }
                    }
                } catch (error) {
                    console.error("Chyba p≈ôihl√°≈°en√≠ Firebase:", error);
                    window.userId = crypto.randomUUID();
                    const userIdEl = document.getElementById('userIdDisplay');
                    if (userIdEl) {
                        userIdEl.textContent = `ID: GUEST`;
                    }
                }
            }
            window.isAuthReady = true;
            if (window.initApp) {
                window.initApp();
            }
        });
    } else {
        console.warn("Firebase config nen√≠ k dispozici. Pou≈æ√≠v√°m pouze LocalStorage.");
        window.userId = crypto.randomUUID();
        const userIdEl = document.getElementById('userIdDisplay');
        if (userIdEl) {
            userIdEl.textContent = `ID: OFFLINE`;
        }
        window.isAuthReady = true;
        if (window.initApp) {
            window.initApp();
        }
    }
</script>

<!-- Main App Script -->
<script src="scripts/provozni-mapa.js"></script>

</body>
</html>